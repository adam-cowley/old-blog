<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Social Feed Cursor Based Pagination - Adam Cowley | Full Stack Development Lead specialising in Neo4j and Node JS</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Social Feed Cursor Based Pagination" />
<meta property="og:description" content="How to squeeze as much peformance out of a high-traffic, high-volume social feed using Neo4j&#39;s Core API." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.adamcowley.co.uk/neo4j/social-feed-cursor-based-pagination/" />
<meta property="article:published_time" content="2019-07-03T14:21:20+01:00" />
<meta property="article:modified_time" content="2019-07-03T14:21:20+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Social Feed Cursor Based Pagination"/>
<meta name="twitter:description" content="How to squeeze as much peformance out of a high-traffic, high-volume social feed using Neo4j&#39;s Core API."/>


	
	<link rel="stylesheet" type="text/css" media="screen" href="/css/adamcowley.css" />

	
	
</head>

<body>
		<header class="header clear" role="banner" id="header">
		<div class="container">
			<h1 class="logo">
				<a href="/">
					<img src="/img/ac-green.svg" alt="Adam Cowley | Full Stack Development Lead specialising in Neo4j and Node JS">
				</a>
			</h1>
			<nav class="nav" role="navigation">
				<ul>
					
					<li>
						<a href="/categories/javascript/">javascript</a>
					</li>
					
					<li>
						<a href="/categories/neo4j/">neo4j</a>
					</li>
					<li>
        <a href="http://twitter.com/adamcowley" target="_blank">
            <svg style="height:24px;width:24px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve"> <path id="Twitter__x28_alt_x29_" d="M84.803,46.564c5.055-0.417,8.483-2.715,9.803-5.833c-1.824,1.12-7.484,2.341-10.61,1.178 	c-0.153-0.734-0.324-1.432-0.492-2.062c-2.382-8.746-10.537-15.792-19.082-14.941c0.691-0.279,1.392-0.539,2.092-0.772 	c0.94-0.337,6.459-1.235,5.59-3.183c-0.733-1.713-7.475,1.295-8.744,1.688c1.675-0.63,4.447-1.714,4.743-3.64 	c-2.567,0.352-5.087,1.566-7.034,3.331c0.703-0.757,1.236-1.679,1.349-2.672C55.57,24.033,51.57,32.853,48.333,41.408 	c-2.542-2.463-4.795-4.403-6.816-5.48c-5.67-3.041-12.449-6.213-23.091-10.164c-0.327,3.521,1.741,8.203,7.7,11.316 	c-1.291-0.173-3.652,0.213-5.54,0.665c0.769,4.034,3.28,7.357,10.079,8.964c-3.107,0.205-4.713,0.912-6.168,2.436 	c1.415,2.805,4.868,6.107,11.08,5.429c-6.906,2.977-2.816,8.49,2.804,7.667C28.794,72.143,13.679,71.416,5,63.134 	c22.661,30.879,71.921,18.262,79.262-11.481c5.499,0.047,8.733-1.905,10.738-4.057C91.831,48.134,87.239,47.578,84.803,46.564z"></path> </svg>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/adamcowley/" target="_blank">
            <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve" style="enable-background:new 0 0 100 100; width: 18px;height: 26px;">
<path id="LinkedIn__x28_alt_x29_" d="M87.877,5.608H11.174c-3.673,0-6.65,2.886-6.65,6.448v77.101c0,3.562,2.978,6.451,6.65,6.451
h76.703c3.673,0,6.646-2.89,6.646-6.451V12.056C94.523,8.495,91.55,5.608,87.877,5.608z M31.809,80.944H18.211V40.31h13.598V80.944z
M25.011,34.759H24.92c-4.56,0-7.516-3.119-7.516-7.023c0-3.983,3.043-7.017,7.693-7.017c4.651,0,7.512,3.033,7.602,7.017
C32.699,31.641,29.749,34.759,25.011,34.759z M80.827,80.944H67.233v-21.74c0-5.464-1.97-9.191-6.886-9.191
c-3.761,0-5.993,2.515-6.973,4.942c-0.364,0.868-0.453,2.08-0.453,3.292v22.696H39.329c0,0,0.178-36.823,0-40.634h13.593v5.761
c1.805-2.768,5.029-6.717,12.249-6.717c8.947,0,15.656,5.804,15.656,18.291V80.944z M52.834,46.199
c0.024-0.038,0.056-0.084,0.088-0.128v0.128H52.834z" />
</svg>
        </a>
    </li>
				</ul>
			</nav>
		</div>
	</header>

	<div class="main">

		<main role="main">

		<section>





	<div class="introduction">
		<div class="container">
			
			<h1>Social Feed Cursor Based Pagination</h1>
		</div>
	</div>

	<div class="container content single">
		<section>
			<article class="post">
				<p class="date">
					<time datetime="2019-07-03 14:21">
						03/07/2019 14:21
					</time>
				</p>

				

<p>Ever since reading the <a href="http://www.odbms.org/blog/2018/07/on-using-graph-database-technology-at-behance-interview-with-david-fox/">ODBMS interview with David Fox of Adobe</a>, I&rsquo;ve been eager to work on a large scale social network.  By switching the underlying database for the Behance social feed from Cassandra to Neo4j,they were able to reduce the number of servers from 48 down to a 3 server Neo4j cluster as well as reduce the operational burden of <a href="https://www.quora.com/What-is-fan-out-write-and-fan-out-read-in-scalability">fanning out writes in order to scale reads</a>.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/eg3R0JZxvys" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"  style="margin: 2em auto; display: block;" allowfullscreen></iframe>

<p>At Behance, they managed to reduce:
- Maintenance hours down by 300%
- 60-150x lower storage requirements
- 48 servers down to 3 of equivalent size - meaninng much lower operation costs.</p>

<p>Those are crazy numbers, but it shows that if you choose the right tool for the job you can save a lot of time and money on both development and infrastructure costs.</p>

<p>With this in mind, I was excited when I was invited into a client a few weeks ago for a Healthcheck.  The company in question has modelled a social feed with over 13M nodes and many more relationships to represent friendships and following &amp; followers.</p>

<h2 id="why-is-a-graph-good-for-a-social-feed">Why is a Graph good for a Social Feed?</h2>

<p>The golden rule is <strong>if the connections between data are as important as the data itself</strong> or <strong>if there are 3 or more joins</strong>, a Graph is the right choice.  In this case, the fact that two Users are connected by friendships and follows relationships, and you&rsquo;re joining Users,Friends and Posts, it makes sense to use a Graph Database.</p>

<p><a href="https://www.youtube.com/watch?v=BfPDZf2wmqg&amp;list=PL9Hl4pk2FsvVPIWPaKBHYSXpL0txJmwuS&amp;index=2">Jim Webber puts this better than I ever could</a>.</p>

<p>You can assume that most clients have a requirement of request times of less than 500ms, otherwise the user will start to feel the difference.  With networks of this scale with millions of users, each with an average of 100-500 friends and potentially hundreds of millions of posts between them, it is important to squeeze as much performance as possible out of the database.</p>

<p>This is where <a href="https://medium.com/@dmccreary/how-to-explain-index-free-adjacency-to-your-manager-1a8e68ec664a">index-free adjacency</a> advantage of a Graph Native Database comes in.  Regardless of the size of the database, pointer chasing through nodes and relationships in memory is much quicker than scanning indexes on join tables.  Say you have a pivot table called <code>friends</code> with two foreign keys, <code>user_id_from</code> and <code>user_id_to</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">source</span>.user_id <span style="color:#66d9ef">AS</span> source_id, friend.user_id <span style="color:#66d9ef">AS</span> friend_id, friendship.since <span style="color:#66d9ef">AS</span> since
<span style="color:#66d9ef">FROM</span>
    <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">source</span>
    <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> friendship <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">source</span>.user_id <span style="color:#f92672">=</span> friendship.user_id_from
    <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">AS</span> friend <span style="color:#66d9ef">ON</span> friendship.user_id_to <span style="color:#f92672">=</span> friend.user_id</code></pre></div>
<p>In this query, you&rsquo;re forced to scan the indexes at read time in order to find friends.  This means the more your user base grows, the slower the query will get.  As friendship is an undirected relationship, you&rsquo;ll also need to add additional logic to check both the from and to indexes, or even worse insert two rows in the database so you know that you can always join on <code>user_id_from</code>.</p>

<p>NoSQL databases are no better for this.  Although they&rsquo;re good at scaling writes, at read time you&rsquo;ll end up scanning indexes and even adding a collection of user id&rsquo;s against each user to hold friends and follows.  Again, for an undirected relationship, you&rsquo;ll need to update two records.</p>

<p>In both examples, you&rsquo;ll also have to fan out to optimise reads.  When a post is created, you&rsquo;ll have to append the post&rsquo;s ID to the posts collection on <strong>each</strong> of the followers.  This is unnecessary complexity for a problem that can be easily solved in a Graph.  If you want to add a new feature, you&rsquo;ve got even more code to write.</p>

<p>This example is trivial in Neo4j.  Because the data has been stored in a way to make graph operations .  The query is much simpler too.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cypher" data-lang="cypher">MATCH (source:User {id: $id})-[friendship:FRIEND_OF]-(friend) // Undirected relationships, cool!
RETURN source.id AS source_id, friend.user_id AS friend_id friendship.since AS since</code></pre></div>
<p>Then when it comes to loading the User&rsquo;s feed, you&rsquo;ve got a simple Cypher query:</p>

<pre><code>MATCH (:User {id: $id})-[:FRIEND_OF]-()-[:POSTED]-&gt;(post:Post)
RETURN post.createdAt, post.body
ORDER BY post.createdAt DESC LIMIT 10
</code></pre>

<p>As the user base grows, the query time will stay the same thanks to index free adjacency. Once you hit the index on <code>:User(id)</code>, you&rsquo;re pointer chasing in memory rather than computing joins between tables.</p>

<p>As always, it&rsquo;s all about using the right tool for the job.</p>

<h2 id="modelling-a-social-feed">Modelling a Social Feed</h2>

<p>If something is worth doing in Neo4j, chanced are <a href="http://maxdemarzi.com">Max</a> has already done it.  In this case, the model relies heavily on <a href="https://maxdemarzi.com/2016/10/28/news-feeds/">Max&rsquo;s News Feed post</a> written in 2016.  The principles haven&rsquo;t changed.</p>

<p>The <em>TL;DR</em> of the post is that Neo4j is optimised for traversing relationship types.  By encoding the date of the a <code>Post</code> in the relationship name, it means you can traverse a specific subset of a User&rsquo;s posts rather than having to look at everything.  Cut down the number of database hits and the query will be faster.</p>

<p>For now, I&rsquo;ll concentrate on <code>:Post</code>s from <code>User</code>s that a particular User <code>FOLLOWS</code>.  For the posted relationship, the date is encoded as <code>POSTED_ON_{YYYY}_{MM}_{DD}</code> format.  Depending on the level of granularity required, you could just encode the year, or you could go down further to dates and times.</p>

<p><img src="/blog/social-feed-cursor-based-pagination/01-follows-model.svg" alt="(:User)-[:FOLLOWS]-&gt;(:User)-[:POSTED_ON_2019_06_30]-&gt;(:Post)" /></p>

<p>This will allow us to get posts from a User on a particular day.</p>

<h2 id="user-defined-procedures">User Defined Procedures</h2>

<p>You <em>could</em> write a Cypher query to pull back the User&rsquo;s posts.  But the requirement here is to squeeze as much performance out of the database as possible.  You cannot specify a dynamic relationship type without some string manipulation in an application layer or expanding all relationships to check the type.  The Core API allows you to do this programatically, so all we would need to do is apply a timestamp or cursor.</p>

<p>Again, <a href="https://maxdemarzi.com/2019/01/28/neo4j-stored-procedures-for-devs-that-dont-know-java-yet/">Max is the authority on this</a> so head over and read his blog for many examples on how to work with the Neo4j Core API and write User Defined Procedures and Functions.</p>

<h3 id="but-why-cursors">But Why Cursors?</h3>

<p>For most cases, a simple <code>SKIP</code> and <code>LIMIT</code>  would be sufficient for pagination.  But with a social feed of hundreds if not thousands of users and posts that is constantly updating, a simple order and limit will not be enough.  By the time the User loads page 2, posts could have been added which would mean a different set of posts would be ordered and limited.  This could lead to users missing vital content.</p>

<p>By using a cursor based approach, you can control where the pagination starts and ends.  So when a User scrolls to the end of the page, you could use a cursor based on the last ID in the post to get the next in the list.  Equally, if you are checking for posts that have been posted since the top result, you can easily identify and find these.</p>

<p>For berevity, I will use the first or last Post ID as the cursor, this way there is a quick lookup on the ID to find when the post was posted.  This could also be a timestamp based on the post timestamp or some encoded value.</p>

<p>So the procedure should do the following:</p>

<ol>
<li>Find the User by it&rsquo;s Username</li>
<li>Expand the <code>FOLLOWS</code> relationship to find all Users that the original user is following</li>
<li>Given the ID of the last post, find the timestamp of the post.  Or fallback to today&rsquo;s date if no cursor exists</li>
<li>Find all posts on the day of the cursor</li>
<li>Repeat the process for the next day until the limit is reached</li>
<li>Decorate the posts with standard information including the poster, likes, comments, reposts, etc</li>
<li>Return a Stream of POJO&rsquo;s that hold the posts</li>
</ol>

<p>By deploying this as a procedure, we can wrap some pretty complex code into a single call.  The results could then be <code>YIELD</code>ed into a cypher query where further information could be gathered in the Cypher statement or simply just returned.  The Cypher query will look something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cypher" data-lang="cypher">CALL social.feed($username, $limit, $cursorType, $cursor)
YIELD post
RETURN post</code></pre></div>
<p></p>

<h2 id="the-procedure">The Procedure</h2>

<h3 id="dependencies">Dependencies</h3>

<p>There are two dependencies needed to use the Core API&rsquo;s.  First, the Core API package (<code>org.neo4j.neo4j</code>) and the Test Harness (<code>org.neo4j.test.neo4j-harness</code>) for testing purposes.  These releases are versioned in align with Neo4j versions, so I&rsquo;ve gone for the latest version here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gradle" data-lang="gradle"><span style="color:#75715e">// build.gradle
</span><span style="color:#75715e"></span>project<span style="color:#f92672">.</span><span style="color:#a6e22e">ext</span> <span style="color:#f92672">{</span>
    neo4jVersion <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.5.6&#39;</span>
<span style="color:#f92672">}</span>

dependencies <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Neo4j Core
</span><span style="color:#75715e"></span>    compileOnly group: <span style="color:#e6db74">&#39;org.neo4j&#39;</span><span style="color:#f92672">,</span> name: <span style="color:#e6db74">&#39;neo4j&#39;</span><span style="color:#f92672">,</span> version: project<span style="color:#f92672">.</span><span style="color:#a6e22e">neo4jVersion</span>

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Neo4j Test Harness
</span><span style="color:#75715e"></span>    testCompile group: <span style="color:#e6db74">&#39;org.neo4j.test&#39;</span><span style="color:#f92672">,</span> name: <span style="color:#e6db74">&#39;neo4j-harness&#39;</span><span style="color:#f92672">,</span> version: project<span style="color:#f92672">.</span><span style="color:#a6e22e">neo4jVersion</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>When I first started with Java, I preferred the look of a gradle file over a Maven xml file and I&rsquo;m stubbornly sticking to it here.  I like that you can define the <code>neo4jVersion</code> as part of the project config and quickly update it if you&rsquo;re updating the project for a later release of Neo4j.  <a href="https://mvnrepository.com/artifact/org.neo4j">The same dependencies can</a> also be included in a Maven project if you&rsquo;re that way inclined.</p>

<h3 id="context-variables"><code>@Context</code> variables</h3>

<p>Neo4j will automatically inject three instances objects into a class.</p>

<ul>
<li>The <code>GraphDatabaseService</code> will be used to interact with the Java Core API.</li>
<li>The <code>Log</code> class be used to log information to the Neo4j log files.</li>
<li>The <code>TerminationGuard</code> allows long running procedures to check at regular intervals if the surrounding query has been terminated or has timed out and terminate itself appropriately.</li>
</ul>

<p>These need to public and non-final and annotated as <code>@Context</code>.  Apart from <code>@Context</code>-annotated variables, classes that define procedures or functions should only contain static variables.  Here weâ€™re defining a Customer label that we will use later on in the class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">import org</span>.<span style="color:#a6e22e">neo4j</span>.<span style="color:#a6e22e">graphdb</span>.<span style="color:#a6e22e">GraphDatabaseService</span>;
<span style="color:#960050;background-color:#1e0010">import org</span>.<span style="color:#a6e22e">neo4j</span>.<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Log</span>;
<span style="color:#960050;background-color:#1e0010">import org</span>.<span style="color:#a6e22e">neo4j</span>.<span style="color:#a6e22e">procedure</span>.<span style="color:#a6e22e">Context</span>;
<span style="color:#960050;background-color:#1e0010">import org</span>.<span style="color:#a6e22e">neo4j</span>.<span style="color:#a6e22e">procedure</span>.<span style="color:#a6e22e">TerminationGuard</span>;

<span style="color:#960050;background-color:#1e0010">public class </span>Feed {

    <span style="color:#75715e">// Context variables must be public and non-final
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Context</span>
    <span style="color:#960050;background-color:#1e0010">public GraphDatabaseService </span>db;

    <span style="color:#a6e22e">@Context</span>
    <span style="color:#960050;background-color:#1e0010">public Log </span>log;

    <span style="color:#a6e22e">@Context</span>
    <span style="color:#960050;background-color:#1e0010">public TerminationGuard </span>guard;

    <span style="color:#75715e">// Everything that isn&#39;t a context variable must be Sstatic
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">private static Label User </span><span style="color:#f92672">=</span> Label.<span style="color:#a6e22e">label</span>(<span style="color:#e6db74">&#34;User&#34;</span>);

    <span style="color:#75715e">// Write some Procedures
</span><span style="color:#75715e"></span>}</code></pre></div>
<h3 id="procedure-definition">Procedure Definition</h3>

<p>Next, a procedure function needs to be defined.  In order to make this callable from a Cypher query it needs to be annotated with the <code>@Procedure</code> annotation.  By default, the procedure will be named <code>{packageName}.{functionName}</code>, but this can be overridden by providing a <code>name</code> value.
A <code>@Description</code> parameter can be added to provide a friendly description for end users.  Any parameters passed into the function need to be annotated with <code>@Name</code>, and can be given a <code>defaultValue</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Procedure</span>(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;social.feed&#34;</span>)
<span style="color:#a6e22e">@Description</span>(<span style="color:#e6db74">&#34;social.feed(username, [limit, [cursorType, since]]) :: post, author | Get the feed for a user&#34;</span>)
<span style="color:#960050;background-color:#1e0010">public Stream</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">PostResult&gt; socialFeed</span>(
        <span style="color:#a6e22e">@Name</span>(<span style="color:#e6db74">&#34;username&#34;</span>) <span style="color:#960050;background-color:#1e0010">String username</span>,
        <span style="color:#a6e22e">@Name</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;limit&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10&#34;</span>) <span style="color:#960050;background-color:#1e0010">Double limit</span>,
        <span style="color:#a6e22e">@Name</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cursor&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;before&#34;</span>) <span style="color:#960050;background-color:#1e0010">String cursorType</span>,
        <span style="color:#a6e22e">@Name</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sinceId&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#960050;background-color:#1e0010">String sinceId
</span><span style="color:#960050;background-color:#1e0010"></span>) {
    <span style="color:#75715e">// Code here...
</span><span style="color:#75715e"></span>}</code></pre></div>
<h3 id="result-pojo">Result POJO</h3>

<p>As you can see, the procedure returns a <code>java.util.Stream</code> of <code>PostResult</code>.  This is simply a <strong>POJO</strong>(Plain old Java Object) where any public property in the POJO can be <code>YIELD</code>ed into the query.  In this case I just want to return a <code>Map</code> that represents the decorated post.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">public class </span>PostResult
{
    <span style="color:#75715e">// Can be yielded
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">public Map</span><span style="color:#f92672">&lt;</span>String, <span style="color:#960050;background-color:#1e0010">Object&gt; post</span>;

    <span style="color:#75715e">// Cannot be yielded
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">private Object </span>hidden;

    <span style="color:#960050;background-color:#1e0010">public PostResult</span>(Map<span style="color:#f92672">&lt;</span>String, <span style="color:#960050;background-color:#1e0010">Object&gt; post</span>) {
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">post</span> <span style="color:#f92672">=</span> post;
    }
}</code></pre></div>
<h3 id="the-service">The Service</h3>

<p>I prefer to split my procedures out into their own classes so it makes them easier to unit test. Any interactions with the graph start with the <code>GraphDatabaseService</code> so I will add this as a parameter on the constructor.  The <code>Log</code> class is also useful for logging information out into neo4j.log.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">public class </span>GetFeed
{
    <span style="color:#960050;background-color:#1e0010">private final GraphDatabaseService db</span>;
    <span style="color:#960050;background-color:#1e0010">private final Log log</span>;

    <span style="color:#960050;background-color:#1e0010">public GetFeed</span>( <span style="color:#960050;background-color:#1e0010">GraphDatabaseService db</span>, <span style="color:#960050;background-color:#1e0010">Log log </span>) {
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> db;
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">log</span> <span style="color:#f92672">=</span> log;
    }

    <span style="color:#75715e">// Code here...
</span><span style="color:#75715e"></span>}</code></pre></div>
<p>Then, define a function that can be called in the procedure definition, taking the user&rsquo;s username, the type of cursor, the cursor itself and the number of results to return.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">public Stream</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">PostResult&gt; forUser</span>(
    <span style="color:#960050;background-color:#1e0010">String username</span>,
    <span style="color:#960050;background-color:#1e0010">String cursorType</span>,
    <span style="color:#960050;background-color:#1e0010">String sinceId</span>,
    <span style="color:#960050;background-color:#1e0010">Double limit
</span><span style="color:#960050;background-color:#1e0010"></span>) {
    <span style="color:#75715e">// Code here...
</span><span style="color:#75715e"></span>}</code></pre></div>
<p>Now we can write some code to pull the user&rsquo;s feed.</p>

<h4 id="getting-the-user">Getting the User</h4>

<p>The <code>GraphDatabaseService::findNode</code> function allows you to find a single node based on a property.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">private Node </span>getUser(<span style="color:#960050;background-color:#1e0010">String username</span>) {
    <span style="color:#66d9ef">return</span> db.<span style="color:#a6e22e">findNode</span>( Labels.<span style="color:#a6e22e">User</span>, Properties.<span style="color:#a6e22e">username</span>, username );
}</code></pre></div>
<h4 id="list-of-follows">List of Follows</h4>

<p>The <code>Node</code> object allows you to expand nodes in various combinations, allowing you to get all relationships in any direction or of a specific type.  In this case, we want posts from Users that the current user follows and also their friends through the <code>FRIEND_OF</code> relationship in either direction.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">private Set</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">Node&gt; getFollowing</span>(<span style="color:#960050;background-color:#1e0010">Node user</span>) {
    <span style="color:#960050;background-color:#1e0010">Set&lt;Node&gt; users </span><span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>(  );

    <span style="color:#75715e">// (user)-[:FOLLOWS]-&gt;(:User)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> ( <span style="color:#960050;background-color:#1e0010">Relationship rel </span><span style="color:#f92672">:</span> user.<span style="color:#a6e22e">getRelationships</span>( RelationshipTypes.<span style="color:#a6e22e">FOLLOWS</span>, Direction.<span style="color:#a6e22e">OUTGOING</span> ) ) {
        users.<span style="color:#a6e22e">add</span>( rel.<span style="color:#a6e22e">getOtherNode</span>( user ) );
    }

    <span style="color:#75715e">// (user)-[:FRIEND_OF]-(:User)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> ( <span style="color:#960050;background-color:#1e0010">Relationship rel </span><span style="color:#f92672">:</span> user.<span style="color:#a6e22e">getRelationships</span>( RelationshipTypes.<span style="color:#a6e22e">FRIEND_OF</span>, Direction.<span style="color:#a6e22e">BOTH</span> ) ) {
        users.<span style="color:#a6e22e">add</span>( rel.<span style="color:#a6e22e">getOtherNode</span>( user ) );
    }

    <span style="color:#66d9ef">return</span> users;
}</code></pre></div>
<h4 id="posts-by-cursor">Posts by Cursor</h4>

<p>Next, we need to get an upper bound for the dated relationships to traverse.  If no cursor/ID is specified, the code should fall back to the current date and time.  Otherwise, we&rsquo;ll need a function to look up a post by it&rsquo;s ID and use it&rsquo;s <code>createdAt</code> property.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Default Date to current time
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">ZonedDateTime dateTime </span><span style="color:#f92672">=</span> ZonedDateTime.<span style="color:#a6e22e">now</span>();

<span style="color:#75715e">// If a post ID is specified, then get a
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> ( sinceId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>sinceId.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;&#34;</span>) ) {
    dateTime <span style="color:#f92672">=</span> getPostTime( sinceId );
}</code></pre></div>
<p>Again, you can use <code>db.findNode</code> to get a Node of a particular label by a key/value pairing.  If the post is found, the <code>getProperty</code> method will allow you to access the property.  Otherwise, fallback to the current date and time.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">private ZonedDateTime </span>getPostTime(<span style="color:#960050;background-color:#1e0010">String postId</span>) {
    <span style="color:#960050;background-color:#1e0010">Node post </span><span style="color:#f92672">=</span> db.<span style="color:#a6e22e">findNode</span>( Labels.<span style="color:#a6e22e">Post</span>, Properties.<span style="color:#a6e22e">postId</span>, postId );

    <span style="color:#66d9ef">if</span> ( post <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> ) {
        <span style="color:#66d9ef">return</span> (ZonedDateTime) post.<span style="color:#a6e22e">getProperty</span>( Properties.<span style="color:#a6e22e">postCreatedAt</span>, ZonedDateTime.<span style="color:#a6e22e">now</span>() );
    }

    <span style="color:#75715e">// Post not found, use the current date and time
</span><span style="color:#75715e"></span>    log.<span style="color:#a6e22e">debug</span>( <span style="color:#e6db74">&#34;Cannot find post &#34;</span><span style="color:#f92672">+</span> postId <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;. Using now() as value&#34;</span> );
    <span style="color:#66d9ef">return</span> ZonedDateTime.<span style="color:#a6e22e">now</span>();
}</code></pre></div>
<h3 id="getting-before-after-the-cursor">Getting Before After the Cursor</h3>

<p>After finding the date and time of the last viewed post, the next thing required is a function that will iterate through the list of users that the current user is following, find any posts that they&rsquo;ve made on this day and by traversing the dated relationship and add them to a <code>List</code> and sort them by their created date.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">private List</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">Node&gt; getPostsOnDate</span>(<span style="color:#960050;background-color:#1e0010">Set&lt;Node&gt; users</span>, <span style="color:#960050;background-color:#1e0010">ZonedDateTime date</span>, <span style="color:#960050;background-color:#1e0010">Comparator comparator</span>) {
    <span style="color:#960050;background-color:#1e0010">List&lt;Node&gt; output </span><span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>(  );

    <span style="color:#75715e">// Get all posts from each user on the date
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">RelationshipType relType </span><span style="color:#f92672">=</span> RelationshipType.<span style="color:#a6e22e">withName</span>( String.<span style="color:#a6e22e">format</span>(POSTED_ON,  date.<span style="color:#a6e22e">format</span>( Time.<span style="color:#a6e22e">formatter</span> )) );

    <span style="color:#66d9ef">for</span> ( <span style="color:#960050;background-color:#1e0010">Node user </span><span style="color:#f92672">:</span> users ) {
        <span style="color:#66d9ef">for</span> ( <span style="color:#960050;background-color:#1e0010">Relationship rel</span><span style="color:#f92672">:</span> user.<span style="color:#a6e22e">getRelationships</span>( relType, Direction.<span style="color:#a6e22e">OUTGOING</span>) ) {
            <span style="color:#75715e">// Add to output
</span><span style="color:#75715e"></span>            output.<span style="color:#a6e22e">add</span>( rel.<span style="color:#a6e22e">getEndNode</span>() );
        }
    }

    <span style="color:#75715e">// Sort
</span><span style="color:#75715e"></span>    output.<span style="color:#a6e22e">sort</span>(
        Comparator.<span style="color:#a6e22e">comparing</span>(
            n <span style="color:#f92672">-&gt;</span> ( (ZonedDateTime) ((Node) n).<span style="color:#a6e22e">getProperty</span>( Properties.<span style="color:#a6e22e">postCreatedAt</span> ) ).<span style="color:#a6e22e">toEpochSecond</span>(),
            comparator
        )
    );

    <span style="color:#66d9ef">return</span> output;
}</code></pre></div>
<p>Because there may be no posts at all on this date to fill the limit, or possibly too many, a function is needed to to keep checking the previous days until either the limit is reached.  A floor is also needed to stop the function running in an infinite loop.  In this case, I have chosen an abitrary date of 3 December 2007, but this could just as easily be the date of the first post in the database.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">private List</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">Node&gt; getPostsBefore</span>(<span style="color:#960050;background-color:#1e0010">Set users</span>, <span style="color:#960050;background-color:#1e0010">ZonedDateTime dateTime</span>, <span style="color:#960050;background-color:#1e0010">Double limit</span>) {
    <span style="color:#960050;background-color:#1e0010">final List</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">Node&gt; output </span><span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>(  );

    <span style="color:#960050;background-color:#1e0010">ZonedDateTime originalDateTime </span><span style="color:#f92672">=</span> dateTime;

    <span style="color:#75715e">// Set a minimum date to stop the code running forever
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">ZonedDateTime floor </span><span style="color:#f92672">=</span> ZonedDateTime.<span style="color:#a6e22e">parse</span>(<span style="color:#e6db74">&#34;2007-12-03T10:15:30+01:00[Europe/London]&#34;</span>);

    <span style="color:#66d9ef">while</span> ( output.<span style="color:#a6e22e">size</span>() <span style="color:#f92672">&lt;</span> limit <span style="color:#f92672">&amp;&amp;</span> dateTime.<span style="color:#a6e22e">isAfter</span>( floor ) ) {
        <span style="color:#960050;background-color:#1e0010">List&lt;Node&gt; posts </span><span style="color:#f92672">=</span> getPostsOnDate(users, dateTime, reverseOrder());

        posts.<span style="color:#a6e22e">forEach</span>( n <span style="color:#f92672">-&gt;</span> {
            <span style="color:#960050;background-color:#1e0010">ZonedDateTime postCreatedAt </span><span style="color:#f92672">=</span> (ZonedDateTime) ((Node) n).<span style="color:#a6e22e">getProperty</span>( Properties.<span style="color:#a6e22e">postCreatedAt</span> );

            <span style="color:#75715e">// Add to the
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ( postCreatedAt.<span style="color:#a6e22e">isBefore</span>( originalDateTime ) ) {
                output.<span style="color:#a6e22e">add</span>( n );
            }
        } );

        <span style="color:#75715e">// Try again with the day before
</span><span style="color:#75715e"></span>        dateTime <span style="color:#f92672">=</span> dateTime.<span style="color:#a6e22e">minusDays</span>(1);
    }

    <span style="color:#75715e">// Trim to size and return
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> output.<span style="color:#a6e22e">subList</span>( 0, Math.<span style="color:#a6e22e">min</span>(limit.<span style="color:#a6e22e">intValue</span>(), output.<span style="color:#a6e22e">size</span>()) );
}</code></pre></div>
<p>Once the from each date are found, a check is added to make sure that the date is after the time of the original post so you don&rsquo;t return any duplicates.  Then the list is trimmed to size using the <code>limit</code> variable supplied into the function.</p>

<h3 id="decorating-posts">Decorating Posts</h3>

<h3 id="posts-after-the-cursor">Posts after the Cursor</h3>

<p>For the sake of berevity, I will skip the implementation of the <code>getPostsAfter</code> method in this post but if you are curious then <a href="https://github.com/adam-cowley/social/blob/master/src/main/java/ac/owley/social/feed/procedures/GetFeed.java#L128">you can find the code in the repository</a>.  Essentially the code is similar, but instead of subtracting a day from the date you instead add a day to the date, and set a ceiling rather than a floor to prevent the infinite loop.  There is also some post-processing work to do on the results to reverse the order so they appear correctly in the UI.</p>

<h2 id="tl-dr-putting-it-all-together">TL;DR: Putting it all together</h2>

<p><a href="https://github.com/adam-cowley/social/blob/master/src/main/java/ac/owley/social/feed/procedures/GetFeed.java">The code is available on Github</a> - feel free to clone and try it out for yourself.  The callable function below takes all of the functions into a single method that can be called.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#960050;background-color:#1e0010">public Stream</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">PostResult&gt; forUser</span>(
    <span style="color:#960050;background-color:#1e0010">String username</span>,
    <span style="color:#960050;background-color:#1e0010">String cursorType</span>,
    <span style="color:#960050;background-color:#1e0010">String sinceId</span>,
    <span style="color:#960050;background-color:#1e0010">Double limit
</span><span style="color:#960050;background-color:#1e0010"></span>) {
    <span style="color:#75715e">// Get User
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">Node user </span><span style="color:#f92672">=</span> getUser(username);

    <span style="color:#66d9ef">if</span> ( user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> ) {
        log.<span style="color:#a6e22e">debug</span>( <span style="color:#e6db74">&#34;Cannot find user &#34;</span><span style="color:#f92672">+</span> username <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;. Returning empty stream&#34;</span> );
        <span style="color:#66d9ef">return</span> Stream.<span style="color:#a6e22e">empty</span>();
    }

    <span style="color:#75715e">// Get Following
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">Set following </span><span style="color:#f92672">=</span> getFollowing( user );

    <span style="color:#66d9ef">if</span> ( following.<span style="color:#a6e22e">size</span>() <span style="color:#f92672">==</span> 0 ) {
        log.<span style="color:#a6e22e">debug</span>( <span style="color:#e6db74">&#34;User&#34;</span><span style="color:#f92672">+</span> username <span style="color:#f92672">+</span><span style="color:#e6db74">&#34; isn&#39;t following anyone. Returning empty stream&#34;</span> );
        <span style="color:#66d9ef">return</span> Stream.<span style="color:#a6e22e">empty</span>();
    }

    <span style="color:#75715e">// Get Date of last/next post
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">ZonedDateTime dateTime </span><span style="color:#f92672">=</span> ZonedDateTime.<span style="color:#a6e22e">now</span>();

    <span style="color:#66d9ef">if</span> ( sinceId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>sinceId.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;&#34;</span>) ) {
        dateTime <span style="color:#f92672">=</span> getPostTime( sinceId );
    }

    <span style="color:#75715e">// Correct Cursor Type
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( cursorType <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> ( <span style="color:#f92672">!</span>cursorType.<span style="color:#a6e22e">equals</span>(CURSOR_TYPE_BEFORE) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>cursorType.<span style="color:#a6e22e">equals</span>(CURSOR_TYPE_AFTER) ) ) {
        cursorType <span style="color:#f92672">=</span> CURSOR_TYPE_BEFORE;
    }

    <span style="color:#960050;background-color:#1e0010">List&lt;Node&gt; output</span>;

    <span style="color:#66d9ef">if</span> ( cursorType.<span style="color:#a6e22e">equals</span>(CURSOR_TYPE_AFTER) ) {
        output <span style="color:#f92672">=</span> getPostsAfter(following, dateTime, limit);
    }
    <span style="color:#66d9ef">else</span> {
        output <span style="color:#f92672">=</span> getPostsBefore(following, dateTime, limit);
    }

    <span style="color:#75715e">// Get the next X posts before this post
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> output
            .<span style="color:#a6e22e">stream</span>()
            .<span style="color:#a6e22e">map</span>(e <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">new</span> PostResult( Decorator.<span style="color:#a6e22e">decoratePost</span>( e ) ));
}</code></pre></div>
<p>The <code>GetFeed</code> class can then be instantiated in the <code>@Procedure</code> annotated function and called with the parameters passed through from the Cypher call.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Procedure</span>(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;social.feed&#34;</span>)
<span style="color:#a6e22e">@Description</span>(<span style="color:#e6db74">&#34;social.feed(username, [limit, [cursorType, since]]) :: post, author | Get the feed for a user&#34;</span>)
<span style="color:#960050;background-color:#1e0010">public Stream</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">PostResult&gt; socialFeed</span>(
        <span style="color:#a6e22e">@Name</span>(<span style="color:#e6db74">&#34;username&#34;</span>) <span style="color:#960050;background-color:#1e0010">String username</span>,
        <span style="color:#a6e22e">@Name</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;limit&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10&#34;</span>) <span style="color:#960050;background-color:#1e0010">Double limit</span>,
        <span style="color:#a6e22e">@Name</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cursor&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;before&#34;</span>) <span style="color:#960050;background-color:#1e0010">String cursorType</span>,
        <span style="color:#a6e22e">@Name</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sinceId&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#960050;background-color:#1e0010">String sinceId
</span><span style="color:#960050;background-color:#1e0010"></span>) {
    <span style="color:#960050;background-color:#1e0010">GetFeed feed </span><span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GetFeed(db, log);

    <span style="color:#66d9ef">return</span> feed.<span style="color:#a6e22e">forUser</span>(username, cursorType, sinceId, limit);
}</code></pre></div>
<h2 id="testing-the-procedure">Testing the Procedure</h2>

<p>The Neo4j Test Harness comes with a <code>Neo4jRule</code> class which exposes an implementation of Neo4j for test purposes.  This can be used to create an in-memory database.  The <code>.withProcedure</code> method will allow us to load any classes that contain procedure definitions into the Test Server.  Any test data required for the test can be loaded in using the <code>.withFixture</code> method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Rule</span>
<span style="color:#960050;background-color:#1e0010">public final Neo4jRule neo4j </span><span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Neo4jRule()
    <span style="color:#75715e">// Register Procedures
</span><span style="color:#75715e"></span>    .<span style="color:#a6e22e">withProcedure</span>(Procedures.<span style="color:#a6e22e">class</span>)

    <span style="color:#75715e">// Cypher query that creates an example dataset
</span><span style="color:#75715e"></span>    .<span style="color:#a6e22e">withFixture</span>(<span style="color:#e6db74">&#34;CREATE (n) ...&#34;</span>);</code></pre></div>
<p>Then a test method can be written to execute a Cypher statement and make some assertions on the result.  There is a more verbose example of the test class <a href="https://github.com/adam-cowley/social/blob/master/src/test/java/ac/owley/social/feed/FeedTest.java">in the repository</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Test</span>
<span style="color:#960050;background-color:#1e0010">public void </span>shouldMountMyProcedures() <span style="color:#960050;background-color:#1e0010">throws Throwable </span>{
    <span style="color:#960050;background-color:#1e0010">GraphDatabaseService db </span><span style="color:#f92672">=</span> neo4j.<span style="color:#a6e22e">getGraphDatabaseService</span>();

    <span style="color:#66d9ef">try</span> ( <span style="color:#960050;background-color:#1e0010">Transaction tx </span><span style="color:#f92672">=</span> db.<span style="color:#a6e22e">beginTx</span>() ) {
        <span style="color:#960050;background-color:#1e0010">Result res </span><span style="color:#f92672">=</span> db.<span style="color:#a6e22e">execute</span>(<span style="color:#e6db74">&#34;CALL social.feed(&#39;adam&#39;, 10) YIELD post RETURN post&#34;</span>);

        <span style="color:#75715e">// Result is an Iterator so you can get the `next` post
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// or iterate over the results in a for loop
</span><span style="color:#75715e"></span>        <span style="color:#960050;background-color:#1e0010">Node node </span><span style="color:#f92672">=</span> (Node) res.<span style="color:#a6e22e">next</span>().<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;post&#34;</span>);

        <span style="color:#75715e">// Make some assertions
</span><span style="color:#75715e"></span>    }
}</code></pre></div>
<h2 id="deploying-the-procedure">Deploying the Procedure</h2>

<p>The deployment process is the only drawback of writing <a href="https://neo4j.com/docs/java-reference/current/extending-neo4j/procedures-and-functions/procedures/">User Defined Procedures &amp; Functions</a>.  For every release, you need to build a jar file, deploy it to all of the Neo4j servers and restart the Neo4j service on each server.  That said, if the performance wins are enough this is a challenge well worth taking on.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Build</span>
gradle build <span style="color:#75715e"># or mvn clean package</span>

<span style="color:#75715e"># Deploy</span>
cp target/project-1.0.jar $NEO4J_HOME/plugins

<span style="color:#75715e"># Restart</span>
$NEO4J_HOME/bin/neo4j restart</code></pre></div>
<p>Once Neo4j has restarted, you should see the procedure listed under <code>dbms.procedures</code>.</p>

<pre><code>call dbms.procedures() YIELD name, description
WITH name, description WHERE name STARTS WITH &quot;social&quot;
RETURN name, description
</code></pre>

<table>
<thead>
<tr>
<th align="left">name</th>
<th align="left">description</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">social.feed</td>
<td align="left"><code>social.feed(username, [limit, [cursorType, since]]) ...</code></td>
</tr>
</tbody>
</table>

<p></p>

<p>There it is.  Now it can be <code>CALL</code>ed in a Cypher Statement with the code in the description.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Neo4j is a great choice for Social Feeds, the database is designed from the ground up to traverse large networks in real time and Cypher makes queries like this a trivial task.  When working with larger graphs, specific relationship types allow you traverse small subgraphs and improve performance by orders of magnitude.  But sometimes these relationships require you to be a little clever, this is where a User Defined Procedure can give you those extra performance wins.</p>

<p><a href="https://github.com/adam-cowley/social">The code that supports this blog post is available on GitHub</a>.</p>

<p>Do you have a social feed in your Neo4j database?  Would you model the data differently?  Drop me a message.   I&rsquo;m <a href="http://twitter.com/adamcowley">@adamcowley on Twitter</a></p>


				

				



    <i class="lnr lnr-tag tag-icon"></i>
    <ul class="tags">
        
        <li>
            <a href="http://www.adamcowley.co.uk/tags/neo4j/">neo4j</a>
        </li>
        <li>
            <a href="http://www.adamcowley.co.uk/tags/java/">java</a>
        </li>
        
        <li>
            <a href="http://www.adamcowley.co.uk/tags/social/">social</a>
        </li></ul>



			</article>
		</section>
	</div>

	
			</section>
		</main>

		<footer class="footer" role="contentinfo">
			

			<div class="container">
				<p class="copyright">
					Copyright &copy; 2020 Adam Cowley.
				</p>
			</div>
			<div class="social">
				<div class="container">
					<ul>
						<li>
        <a href="http://twitter.com/adamcowley" target="_blank">
            <svg style="height:24px;width:24px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve"> <path id="Twitter__x28_alt_x29_" d="M84.803,46.564c5.055-0.417,8.483-2.715,9.803-5.833c-1.824,1.12-7.484,2.341-10.61,1.178 	c-0.153-0.734-0.324-1.432-0.492-2.062c-2.382-8.746-10.537-15.792-19.082-14.941c0.691-0.279,1.392-0.539,2.092-0.772 	c0.94-0.337,6.459-1.235,5.59-3.183c-0.733-1.713-7.475,1.295-8.744,1.688c1.675-0.63,4.447-1.714,4.743-3.64 	c-2.567,0.352-5.087,1.566-7.034,3.331c0.703-0.757,1.236-1.679,1.349-2.672C55.57,24.033,51.57,32.853,48.333,41.408 	c-2.542-2.463-4.795-4.403-6.816-5.48c-5.67-3.041-12.449-6.213-23.091-10.164c-0.327,3.521,1.741,8.203,7.7,11.316 	c-1.291-0.173-3.652,0.213-5.54,0.665c0.769,4.034,3.28,7.357,10.079,8.964c-3.107,0.205-4.713,0.912-6.168,2.436 	c1.415,2.805,4.868,6.107,11.08,5.429c-6.906,2.977-2.816,8.49,2.804,7.667C28.794,72.143,13.679,71.416,5,63.134 	c22.661,30.879,71.921,18.262,79.262-11.481c5.499,0.047,8.733-1.905,10.738-4.057C91.831,48.134,87.239,47.578,84.803,46.564z"></path> </svg>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/adamcowley/" target="_blank">
            <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve" style="enable-background:new 0 0 100 100; width: 18px;height: 26px;">
<path id="LinkedIn__x28_alt_x29_" d="M87.877,5.608H11.174c-3.673,0-6.65,2.886-6.65,6.448v77.101c0,3.562,2.978,6.451,6.65,6.451
h76.703c3.673,0,6.646-2.89,6.646-6.451V12.056C94.523,8.495,91.55,5.608,87.877,5.608z M31.809,80.944H18.211V40.31h13.598V80.944z
M25.011,34.759H24.92c-4.56,0-7.516-3.119-7.516-7.023c0-3.983,3.043-7.017,7.693-7.017c4.651,0,7.512,3.033,7.602,7.017
C32.699,31.641,29.749,34.759,25.011,34.759z M80.827,80.944H67.233v-21.74c0-5.464-1.97-9.191-6.886-9.191
c-3.761,0-5.993,2.515-6.973,4.942c-0.364,0.868-0.453,2.08-0.453,3.292v22.696H39.329c0,0,0.178-36.823,0-40.634h13.593v5.761
c1.805-2.768,5.029-6.717,12.249-6.717c8.947,0,15.656,5.804,15.656,18.291V80.944z M52.834,46.199
c0.024-0.038,0.056-0.084,0.088-0.128v0.128H52.834z" />
</svg>
        </a>
    </li>
					</ul>
				</div>
			</div>
		</footer>
	</div>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-3764211-9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-3764211-9');
</script>



<script src="/js/parts/scripts.js"></script>

</body>
</html>
