<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Building a Real-Time UI on top of Neo4j with Vue.js and Kafka - Adam Cowley | Full Stack Development Lead specialising in Neo4j and Node JS</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Building a Real-Time UI on top of Neo4j with Vue.js and Kafka" />
<meta property="og:description" content="How to build a Real-time UI on top of Neo4j with VueJS using websockets, driven by Kafka and the Neo4j Streams plugin." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.adamcowley.co.uk/neo4j/real-time-ui-vuejs-neo4j-kafka/" />
<meta property="article:published_time" content="2020-01-07T12:55:08+00:00" />
<meta property="article:modified_time" content="2020-01-07T12:55:08+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building a Real-Time UI on top of Neo4j with Vue.js and Kafka"/>
<meta name="twitter:description" content="How to build a Real-time UI on top of Neo4j with VueJS using websockets, driven by Kafka and the Neo4j Streams plugin."/>


	
	<link rel="stylesheet" type="text/css" media="screen" href="/css/adamcowley.css" />

	
	
</head>

<body>
		<header class="header clear" role="banner" id="header">
		<div class="container">
			<h1 class="logo">
				<a href="/">
					<img src="/img/ac-green.svg" alt="Adam Cowley | Full Stack Development Lead specialising in Neo4j and Node JS">
				</a>
			</h1>
			<nav class="nav" role="navigation">
				<ul>
					
					<li>
						<a href="/categories/javascript/">javascript</a>
					</li>
					
					<li>
						<a href="/categories/neo4j/">neo4j</a>
					</li>
					<li>
        <a href="http://twitter.com/adamcowley" target="_blank">
            <svg style="height:24px;width:24px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve"> <path id="Twitter__x28_alt_x29_" d="M84.803,46.564c5.055-0.417,8.483-2.715,9.803-5.833c-1.824,1.12-7.484,2.341-10.61,1.178 	c-0.153-0.734-0.324-1.432-0.492-2.062c-2.382-8.746-10.537-15.792-19.082-14.941c0.691-0.279,1.392-0.539,2.092-0.772 	c0.94-0.337,6.459-1.235,5.59-3.183c-0.733-1.713-7.475,1.295-8.744,1.688c1.675-0.63,4.447-1.714,4.743-3.64 	c-2.567,0.352-5.087,1.566-7.034,3.331c0.703-0.757,1.236-1.679,1.349-2.672C55.57,24.033,51.57,32.853,48.333,41.408 	c-2.542-2.463-4.795-4.403-6.816-5.48c-5.67-3.041-12.449-6.213-23.091-10.164c-0.327,3.521,1.741,8.203,7.7,11.316 	c-1.291-0.173-3.652,0.213-5.54,0.665c0.769,4.034,3.28,7.357,10.079,8.964c-3.107,0.205-4.713,0.912-6.168,2.436 	c1.415,2.805,4.868,6.107,11.08,5.429c-6.906,2.977-2.816,8.49,2.804,7.667C28.794,72.143,13.679,71.416,5,63.134 	c22.661,30.879,71.921,18.262,79.262-11.481c5.499,0.047,8.733-1.905,10.738-4.057C91.831,48.134,87.239,47.578,84.803,46.564z"></path> </svg>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/adamcowley/" target="_blank">
            <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve" style="enable-background:new 0 0 100 100; width: 18px;height: 26px;">
<path id="LinkedIn__x28_alt_x29_" d="M87.877,5.608H11.174c-3.673,0-6.65,2.886-6.65,6.448v77.101c0,3.562,2.978,6.451,6.65,6.451
h76.703c3.673,0,6.646-2.89,6.646-6.451V12.056C94.523,8.495,91.55,5.608,87.877,5.608z M31.809,80.944H18.211V40.31h13.598V80.944z
M25.011,34.759H24.92c-4.56,0-7.516-3.119-7.516-7.023c0-3.983,3.043-7.017,7.693-7.017c4.651,0,7.512,3.033,7.602,7.017
C32.699,31.641,29.749,34.759,25.011,34.759z M80.827,80.944H67.233v-21.74c0-5.464-1.97-9.191-6.886-9.191
c-3.761,0-5.993,2.515-6.973,4.942c-0.364,0.868-0.453,2.08-0.453,3.292v22.696H39.329c0,0,0.178-36.823,0-40.634h13.593v5.761
c1.805-2.768,5.029-6.717,12.249-6.717c8.947,0,15.656,5.804,15.656,18.291V80.944z M52.834,46.199
c0.024-0.038,0.056-0.084,0.088-0.128v0.128H52.834z" />
</svg>
        </a>
    </li>
				</ul>
			</nav>
		</div>
	</header>

	<div class="main">

		<main role="main">

		<section>





	<div class="introduction">
		<div class="container">
			
			<h1>Building a Real-Time UI on top of Neo4j with Vue.js and Kafka</h1>
		</div>
	</div>

	<div class="container content single">
		<section>
			<article class="post">
				<p class="date">
					<time datetime="2020-01-07 12:55">
						07/01/2020 12:55
					</time>
				</p>

				

<p>In this post, I will demonstrate how you can build a real-time application on top of <a href="https://neo4j.com">Neo4j</a> using a few open source plugins.  Due to brevity, this will only be a basic application but you can take the principles and make it as complicated as you need.</p>

<p>For this example, I will also be using <a href="https://vuejs.org/">Vue.js</a> on top of an <a href="https://expressjs.com/">express</a> server communicating through websockets.  If you prefer something like React then it will work just as well.</p>

<p>Also, I&rsquo;m using <a href="https://github.com/adam-cowley/neode">neode</a> - a nodejs based OGM that I wrote for Neo4j.  Again, you could quite easily swap this out for another OGM or just <a href="/javascript/using-the-neo4j-driver-with-nodejs/">run cypher queries against Neo4j</a>  using the <a href="https://www.npmjs.com/package/neo4j-driver">official driver</a>.</p>

<p>With the disclaimers out of the way, let&rsquo;s get going.</p>

<h2 id="overview">Overview</h2>

<p>An idea that I&rsquo;ve had at the back of my mind for a while is to build a collaborative Graph Database modelling tool.  For this, real-time information will have to be passed through to all users that are logged in so a user doesn&rsquo;t overwrite what another user is doing.  For this, I will need to <em>lock</em> and <em>unlock</em> nodes in real-time and pass the message to a user.</p>

<p><img src="/uploads/real-time-ui-vuejs-neo4j-kafka/fig1.png" alt="Diagram detailing the messaging process" title="Diagram detailing the messaging process" /></p>

<ol>
<li>When a user selects a <em>Node</em> in the UI, a <code>lock</code> event should be sent to the API via websockets.  This status update should be distributed to the other users, and that node locked in their front end</li>
<li>As the user drags the <em>Node</em>, a <code>drag</code> event should be sent with the x/y coordinates of the node so this can be reflected in what each other user sees.</li>
<li>When the <em>Node</em> is dropped, the node should be <em>unlocked</em> for all users</li>
</ol>

<h2 id="creating-a-basic-express-api">Creating a basic express API</h2>

<p>Firstly, we need an API that we can send these messages.  The API will be in charge of saving the updates to Neo4j and redistributing the message to all of the other clients.  The first step is to create a new directory which will hold the code, initiate the project and install the required dependencies.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir api <span style="color:#f92672">&amp;&amp;</span> cd $_
npm init -y
npm i -S express neode kafka-node socket.io</code></pre></div>
<ul>
<li><strong>express</strong> - This is an unopinionated framework for building REST APIs</li>
<li><strong>neode</strong> - An OGM that I&rsquo;ll use to take care of the legwork when communicating with Neo4j.</li>
<li><strong>kafka-node</strong> - A library for interacting with Kafka.  This package allows you to create Producers and Consumers in node.</li>
</ul>

<p>For now, let&rsquo;s create a simple Hello World page. that will serve</p>

<div class="file">api/src/index.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>()

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;Hello!&#39;</span>))

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">3000</span>, () =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;Listening on http://localhost:3000&#39;</span>))
</code></pre></div>
<p>Running <code>node index.js</code> and heading to <a href="http://localhost:3000">http://localhost:3000</a>, you should now see a page saying <code>Hello!</code>.</p>

<p>Next step, setting up neode.  For this, I will use the <code>fromEnv</code> function included with neode. This makes life a little easier by allowing you to define the neo4j connection details in a <code>.env</code> file.  We can also use this for the kafka consumer later on.</p>

<div class="file">api/.env</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-env" data-lang="env">NEO4J_PROTOCOL=bolt
NEO4J_HOST=localhost
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=mysecretpassword
NEO4J_PORT=7687</code></pre></div>
<p>To load these settings into <code>process.env</code>, you call the <code>.config()</code> function supplied by <code>dotenv</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// Load the .env variables into process.env
</span><span style="color:#75715e"></span><span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;dotenv&#39;</span>).<span style="color:#a6e22e">config</span>()

<span style="color:#75715e">// Accessing the variable
</span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">NEO4J_HOST</span>) <span style="color:#75715e">// &#34;localhost&#34;
</span></code></pre></div>
<h3 id="data-persistence-with-neode">Data Persistence with Neode</h3>

<p>Next, I&rsquo;ll need a <a href="https://github.com/adam-cowley/neode/#loading-with-models">neode model</a>.  At the risk of causing confusion, I&rsquo;m going to call the nodes we save in the database <code>Node</code>.  I&rsquo;ll want a UUID to serve as a unique ID, a status and x and y coordinates.</p>

<div class="file">api/models/Node.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;uuid&#39;</span>,
        <span style="color:#a6e22e">primary</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
    },
    <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;string&#39;</span>,
        <span style="color:#a6e22e">valid</span><span style="color:#f92672">:</span> [ <span style="color:#e6db74">&#39;locked&#39;</span>, <span style="color:#e6db74">&#39;unlocked&#39;</span>, ], <span style="color:#75715e">// I want two statuses
</span><span style="color:#75715e"></span>    },
    <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;float&#39;</span>,   <span style="color:#75715e">// These are a simple shorthand for {type: &#39;float&#39;}
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;float&#39;</span>,   
}
</code></pre></div>
<p>Then, an instance of neode.  For clarity, I will create this in a new file called <code>neode.js</code> but this could quite easily just be written in index.js.</p>

<div class="file">api/neode.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">neode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;neode&#39;</span>)
    <span style="color:#75715e">// Load using the config in .env
</span><span style="color:#75715e"></span>    .<span style="color:#a6e22e">fromEnv</span>()
    <span style="color:#75715e">// Use the models defined in api/models/*.js
</span><span style="color:#75715e"></span>    .<span style="color:#a6e22e">withDirectory</span>(<span style="color:#a6e22e">__dirname</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/models&#39;</span>)

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">neode</span>
</code></pre></div>
<p>You can then use neode to <a href="https://github.com/adam-cowley/neode/#merging-a-node">create some data</a> and place them at a random x,y coordinate.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">neode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./neode&#39;</span>)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ids</span> <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;61ff4876-e488-4a91-94a6-f8d6bdd35273&#39;</span>,
    <span style="color:#e6db74">&#39;c98e1475-1421-41f9-9f2f-551ce1b1bf5a&#39;</span>,
    <span style="color:#e6db74">&#39;642f2518-b1b8-4405-9dd8-bd19e6a0f487&#39;</span>,
    <span style="color:#e6db74">&#39;be7d130c-a922-4e80-9a84-c0723a8d4710&#39;</span>
];

<span style="color:#a6e22e">ids</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">id</span> =&gt; <span style="color:#a6e22e">neode</span>.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#39;Node&#39;</span>, { <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> Math.<span style="color:#a6e22e">random</span>()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> Math.<span style="color:#a6e22e">random</span>()<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span> }))
</code></pre></div>
<h3 id="communicating-with-socket-io">Communicating with Socket.io</h3>

<p>Next, for the communication between the front end and API.  For this, I&rsquo;ve gone for
<a href="https://socket.io/">socket.io</a> because I&rsquo;ve used this on a few projects in the past and it is relatively easy to set up with express.  But in reality, any websockets implementation will do.</p>

<p>Again, in a new file, I&rsquo;m creating a function that can be called to create a socket.io instance.  I&rsquo;ve done this because the socket needs to be bound to some sort of http server, and at some point will need to communicate with neo4j and the kafka consumer too.</p>

<div class="file">api/io.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createSocket</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">neode</span>, <span style="color:#a6e22e">consumer</span>) =&gt; {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">io</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;socket.io&#39;</span>)(<span style="color:#a6e22e">server</span>)

    <span style="color:#75715e">// Messages will be sent and received here...
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">io</span>
}

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createSocket</span>
</code></pre></div>
<p>Then the function can be imported and called inside <code>index.js</code>.</p>

<div class="file">api/index.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">io</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./io&#39;</span>)(<span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">neode</span>)
</code></pre></div>
<p>The socket.io API is essentially an event emitted and therefore has an extremely simple interface.
On connection, a <code>connection</code> event is fired which provides a <code>socket</code> object.  This contains an
 <code>on(event, callback)</code> function that allows you to execute a callback function when an event is received.</p>

<div class="file">api/io.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;connection&#39;</span>, <span style="color:#a6e22e">socket</span> =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--&gt; JOINED: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>) <span style="color:#75715e">// --&gt; JOINED: Am-spDXUXvNHhuLNAAAD
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Listen for events from that socket
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;disconnect&#39;</span>, () =&gt; {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`&lt;-- LEFT  : </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>) <span style="color:#75715e">// &lt;-- LEFT  : sbIpyb0yM64cYcX_AAAA 
</span><span style="color:#75715e"></span>    })
})
</code></pre></div>
<p>To send a message, you can either use <code>socket.emit(message, payload)</code> to send a message to that socket only, or use <code>io.emit(message, payload)</code> to send a message to all sockets.  Socket.io also has the concept of <a href="https://socket.io/docs/server-api/#socket-rooms">Rooms and Namespaces</a>, which could be useful in a multitenancy environment but that is beyond the scope of this article.</p>

<p>When a user joins for the first time, we might want to do some authentication but for berevity I will skip that step.  When a user joins, I will use neode to query the database and send the current state of the graph to the UI in the form of a <code>welcome</code> message.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;connection&#39;</span>, <span style="color:#a6e22e">socket</span> =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--&gt; JOINED: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>) <span style="color:#75715e">// --&gt; JOINED: Am-spDXUXvNHhuLNAAAD
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">neode</span>.<span style="color:#a6e22e">all</span>(<span style="color:#e6db74">&#39;Node&#39;</span>)
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">res</span> =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">toJson</span>())
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">data</span> =&gt; <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;welcome&#39;</span>, <span style="color:#a6e22e">data</span>))

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>})
</code></pre></div>
<p>In order to handle communications from the client, I&rsquo;ll need to listen for  2 events; <code>lock</code> and <code>unlock</code>.  When the lock event is received with an id in the payload, I will need to use that to update the status of a node in neo4j.  If an unlock event is received, I will need to set the <em>unlocked</em> status should be saved along with the new x and y coordinates.</p>

<p>For now, when a message is received I will simply send out the past tense version to all other connected sockets.  Later on, these messages will be handled by Kafka instead.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// Handle Lock Event
</span><span style="color:#75715e"></span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;lock&#39;</span>, <span style="color:#a6e22e">data</span> =&gt; {
     <span style="color:#a6e22e">neode</span>.<span style="color:#a6e22e">find</span>(<span style="color:#e6db74">&#39;Node&#39;</span>, <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">id</span>)
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">node</span> =&gt; <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">update</span>({
            <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;locked&#39;</span>,
            <span style="color:#75715e">// So we have some context of who locked it, we can use the socket ID
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">by</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">id</span>, 
        }))
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">node</span> =&gt; <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">toJson</span>())
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">json</span> =&gt; <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;locked&#39;</span>, <span style="color:#a6e22e">json</span>))
})

<span style="color:#75715e">// Handle Unlock Event
</span><span style="color:#75715e"></span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;lock&#39;</span>, <span style="color:#a6e22e">data</span> =&gt; {
    <span style="color:#a6e22e">neode</span>.<span style="color:#a6e22e">find</span>(<span style="color:#e6db74">&#39;Node&#39;</span>, <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">id</span>)
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">node</span> =&gt; <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">update</span>({
            <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;unlocked&#39;</span>,
            <span style="color:#a6e22e">by</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>,
            <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">x</span>,
            <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">y</span>,
        }))
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">node</span> =&gt; <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">toJson</span>())
        .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">json</span> =&gt; <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;unlocked&#39;</span>, <span style="color:#a6e22e">json</span>))
})
</code></pre></div>
<p>Great.  That should be enough to get the front end working.</p>

<h2 id="building-a-front-end-with-vue-js">Building a Front End with Vue.js</h2>

<p>Essentially, we want a framework that allows us to build an application quickly and that can consume messages via websockets using jabascript.  My personal preference is Vue.js but you could te easily swap out Vue.js for  React, Angular, Ember, jQuery, Backbone (is that still a thing?!), YourFavouriteFrontEndFramework and the result would be the same.</p>

<p>The <code>@vue/cli</code> tools allow you to quickly generate a project template and get started in minutes.  The following command creates a new project in the <code>ui</code> folder.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">vue create ui</code></pre></div>
<p>There are <a href="https://www.npmjs.com/package/vue-socket.io">several ways</a> to include the Socket.io code in a vue project, but because the implementation is relatively simple I&rsquo;ll just use the <code>socket.io-client</code> package.</p>

<pre><code>cd ui
npm i --save socket.io-client

# serve the project in dev mode
npm run serve
</code></pre>

<p>The easiest way to <a href="http://www.petercollingridge.co.uk/tutorials/svg/interactive/dragging/">create draggable elements</a> is through SVG.  So inside the <code>App.vue</code> component, I&rsquo;ll just add an svg element and use a custom Vue component to represent the nodes - each generating a draggable <code>&lt;circle&gt;</code> element.</p>

<p>When the UI receives the welcome message, it should populate a <code>nodes</code> array.  Each time a locked or unlocked message is received, the corresponding item in that array will be updated and that status reflected in the UI.</p>

<div class="file">App.vue</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">template</span>&gt;
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;app&#34;</span>&gt;
        &lt;<span style="color:#f92672">svg</span> <span style="color:#a6e22e">height</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100%&#34;</span> <span style="color:#a6e22e">width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100%&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;background: #f2f2f2&#34;</span>&gt;
            <span style="color:#75715e">&lt;!-- Node circles will go here --&gt;</span>
        &lt;/<span style="color:#f92672">svg</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;
&lt;/<span style="color:#f92672">template</span>&gt;

&lt;<span style="color:#f92672">script</span>&gt;
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Node</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@/components/Node&#39;</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">io</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;socket.io-client&#39;</span>;

<span style="color:#75715e">// There is probably a more sophisticated way of doing this...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">io</span>(<span style="color:#e6db74">&#39;http://localhost:3000&#39;</span>);

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;app&#39;</span>,
    <span style="color:#a6e22e">components</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">Node</span>,
    },
    <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> () =&gt; ({
        <span style="color:#a6e22e">loading</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
        <span style="color:#a6e22e">selected</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>,

        <span style="color:#a6e22e">nodes</span><span style="color:#f92672">:</span> [],
    }),
}
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>
<p>For the draggable nodes, I&rsquo;ll simply wrap a Vue component <code>&lt;circle&gt;</code> component and apply some handlers.  This way, I can encapsulate the locking and dragging logic and then send back events to the parent component when something interesting happens.  I&rsquo;ve defined these</p>

<div class="file">Node.vue</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vue" data-lang="vue">&lt;<span style="color:#f92672">template</span>&gt;
    &lt;<span style="color:#f92672">circle</span>
        <span style="color:#f92672">:cx</span><span style="color:#e6db74">=&#34;x&#34;</span> <span style="color:#f92672">:cy</span><span style="color:#e6db74">=&#34;y&#34;</span> <span style="color:#f92672">:r</span><span style="color:#e6db74">=&#34;r&#34;</span> <span style="color:#f92672">:style</span><span style="color:#e6db74">=&#34;style&#34;</span>
        <span style="color:#f92672">:</span><span style="color:#a6e22e">title</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34; JSON.stringify(node) &#34;</span>
    /&gt;
&lt;/<span style="color:#f92672">template</span>&gt;

&lt;<span style="color:#f92672">script</span>&gt;
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Node&#39;</span>,
    <span style="color:#a6e22e">props</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">node</span><span style="color:#f92672">:</span> Object,
        <span style="color:#a6e22e">selected</span><span style="color:#f92672">:</span> String,
        <span style="color:#a6e22e">lock</span><span style="color:#f92672">:</span> Function,
        <span style="color:#a6e22e">move</span><span style="color:#f92672">:</span> Function,
        <span style="color:#a6e22e">unlock</span><span style="color:#f92672">:</span> Function,

        <span style="color:#a6e22e">r</span><span style="color:#f92672">:</span> {
            <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> Number,
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span>,
        }
    },
    <span style="color:#75715e">// Start with default values for x and y that will be changed based
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// on the values of the node object passed as a prop
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> () =&gt; ({ <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, }),
}
&lt;/<span style="color:#f92672">script</span>&gt;</code></pre></div>
<p>Because the x and y coordinates can be changed, I can&rsquo;t use these directly from the node object.  So the <code>data()</code> function will return default values.  Then as the component is mounted, or the node object updates this position should be overwritten.</p>

<div class="file">Node.vue</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Node&#39;</span>,
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> () =&gt; ({ <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, }),
    <span style="color:#a6e22e">methods</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">reposition</span>() {
            <span style="color:#75715e">// Set x and y based on the Node object
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">x</span>;
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">y</span>;
        },
    },
    <span style="color:#a6e22e">mounted</span>() {
        <span style="color:#75715e">// Run the function when the component is first mounted
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">reposition</span>()
    },
    <span style="color:#a6e22e">watch</span><span style="color:#f92672">:</span> {
        <span style="color:#75715e">// ... and for any subsequent change to the node object
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">node</span>() {
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">reposition</span>()
        },
    },
}
</code></pre></div>
<h3 id="locking-the-node">Locking the Node</h3>

<p>On mouse down, I want to send a message to the server to say that the node has been locked.  This will be taken care of by the <code>lock</code> function passed as a prop, but I will also need to check that another user hasn&rsquo;t locked the nodeso I need to wrap it in a handler function.  First I need to define a function in the component, then bind that to the onmousedown event.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#a6e22e">methods</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">handleLock</span>(<span style="color:#a6e22e">e</span>) {
        <span style="color:#75715e">// Don&#39;t do anything if it&#39;s already locked
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;locked&#34;</span> ) {
            <span style="color:#66d9ef">return</span>;
        }

        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>)
    },

},
<span style="color:#75715e">// ...
</span></code></pre></div>
<p>To bind events to components, I prefer the shorthand <code>@</code> syntax - so for example, I can bind the function on mouse down, and then use <code>.prevent</code> to prevent any default behaviour (the equivalent of calling <code>event.preventDefault()</code>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">template</span>&gt;
    &lt;<span style="color:#f92672">circle</span>
        <span style="color:#a6e22e">:cx</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;x&#34;</span> <span style="color:#a6e22e">:cy</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;y&#34;</span> <span style="color:#a6e22e">:r</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;r&#34;</span> <span style="color:#a6e22e">:style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;style&#34;</span>
        <span style="color:#a6e22e">:title</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34; JSON.stringify(node) &#34;</span>

        <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">mousedown</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">prevent</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;handleLock&#34;</span>
        <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">mousemove</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">prevent</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;handleMove&#34;</span>
        <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">mouseup</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">prevent</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;handleUnlock&#34;</span>
        <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">mouseout</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#a6e22e">prevent</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;handleUnlock&#34;</span>
    /&gt;
&lt;/<span style="color:#f92672">template</span>&gt;</code></pre></div>
<h3 id="handling-the-drag">Handling the Drag</h3>

<p>Handling the dragging of a component in an SVG is fairly trivial - and is defined in <a href="http://www.petercollingridge.co.uk/tutorials/svg/interactive/dragging/">great detail here</a>.  On mouse move, if this node is selected by the current user, I want to set the <code>cx</code> and <code>cy</code> properties to the position of the mouse.  This information is available from the event.  Because the SVG element is the parent element of the component, it can be accessed by using <code>this.$el</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">handleMove</span>(<span style="color:#a6e22e">e</span>) {
    <span style="color:#66d9ef">if</span> ( <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">selected</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">id</span> ) {
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$el</span>.<span style="color:#a6e22e">setAttributeNS</span>(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#34;cx&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientX</span>)
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$el</span>.<span style="color:#a6e22e">setAttributeNS</span>(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#34;cy&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientY</span>)
    }
},
</code></pre></div>
<p>Then, once the Node has been <em>dropped</em>, I want to <em>unlock</em> the node and send the new position back to the API.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">handleUnlock</span>(<span style="color:#a6e22e">e</span>) {
    <span style="color:#66d9ef">if</span> ( <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">selected</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">id</span> ) {
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">unlock</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">node</span>, {<span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientX</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientY</span>})
    }
},
</code></pre></div>
<h3 id="client-to-server-communication">Client to Server Communication</h3>

<p>Sending and receiving messages from the Socket.io client are similar to the code above.  The <code>socket</code> object has an <code>emit(message, body)</code> function which.  As this will be identical for all messages, I&rsquo;ll implement it as a method on the <code>App</code> component.  For a production ready app you might want to move this into it&rsquo;s own service.</p>

<p>Each of the messages then has a similar signature, just sending a different event name and payload.</p>

<div class="file">App.vue</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;app&#39;</span>,
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">methods</span><span style="color:#f92672">:</span> {
        <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">message</span>, <span style="color:#a6e22e">body</span>) {
            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;sending&#39;</span>, <span style="color:#a6e22e">message</span>, <span style="color:#a6e22e">body</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">message</span>, <span style="color:#a6e22e">body</span>)
        },

        <span style="color:#a6e22e">lock</span>(<span style="color:#a6e22e">node</span>) {
            <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">id</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">node</span>;

            <span style="color:#75715e">// Set selected node in component
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">selected</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">id</span>

            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;lock&#39;</span>, { <span style="color:#a6e22e">id</span>, })
        },
        <span style="color:#a6e22e">move</span>(<span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">data</span>) {
            <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">id</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">node</span>;
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;move&#39;</span>, { <span style="color:#a6e22e">id</span>, ...<span style="color:#a6e22e">data</span> })
        },
        <span style="color:#a6e22e">unlock</span>(<span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">data</span>) {
            <span style="color:#75715e">// Clear selected node in component
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">selected</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>

            <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">id</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">node</span>;
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;unlock&#39;</span>, { <span style="color:#a6e22e">id</span>, ...<span style="color:#a6e22e">data</span> })
        },
    },
}
</code></pre></div>
<p>Now the server can send events, all that is needed is to receive any events that come back.  The <code>created()</code> function is fired when the component is created - this is a perfect place to bind some event listeners for the socket.  As a message comes in, the nodes prop for the component should be updated to reflect the change - whether that is a node locked or unlocked.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;app&#39;</span>,
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">created</span>() {
        <span style="color:#75715e">// Add listeners to set the initial app state on connection
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;welcome&#39;</span>, <span style="color:#a6e22e">nodes</span> =&gt; {
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nodes</span>
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">loading</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
        })

        <span style="color:#75715e">// Handle another user locking a node
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;locked&#39;</span>, <span style="color:#a6e22e">e</span> =&gt; {
            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">locked</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">id</span>);
            <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">index</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> ) {
                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">locked</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">index</span>, <span style="color:#ae81ff">1</span>)
            }

            <span style="color:#75715e">// Update status
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">findIndex</span>(<span style="color:#a6e22e">n</span> =&gt; <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">id</span>)
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span>[ <span style="color:#a6e22e">nodeIndex</span> ].<span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;locked&#34;</span>

            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;LOCKED!&#39;</span>, <span style="color:#a6e22e">e</span>)
        })

        <span style="color:#75715e">// Handle a node becoming unlocked
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;unlocked&#39;</span>, <span style="color:#a6e22e">e</span> =&gt; {
            <span style="color:#75715e">// Remove from locked
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">locked</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">id</span>);
            <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">index</span> <span style="color:#f92672">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> ) {
                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">locked</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">index</span>, <span style="color:#ae81ff">1</span>)
            }

            <span style="color:#75715e">// Update status and position
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">findIndex</span>(<span style="color:#a6e22e">n</span> =&gt; <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">id</span>)

            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span>[ <span style="color:#a6e22e">nodeIndex</span> ].<span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">x</span>
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span>[ <span style="color:#a6e22e">nodeIndex</span> ].<span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">y</span>
            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nodes</span>[ <span style="color:#a6e22e">nodeIndex</span> ].<span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;unlocked&#34;</span>

            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;UNLOCKED!&#39;</span>, <span style="color:#a6e22e">e</span>)
        })
    },
}
</code></pre></div>
<p>A quick test shows that any changes made in one browser window are reflected in other browser windows.</p>

<video width="100%" controls>
  <source src="/uploads/real-time-ui-vuejs-neo4j-kafka/sync720.mov">
</video>

<h3 id="publishing-updates-with-neo4j-streams">Publishing Updates with Neo4j Streams</h3>

<p>This is fine for a small application, but wouldn&rsquo;t work at scale.  If you try to run the API in a load balanced environment only the other users that happen to be connected to the server that received the update would be updated.  This is where Kafka comes in, when data is updated in Neo4j we can push it out to a Kafka topic.  Then, we can create a Consumer in <code>api/src/index.js</code> which will consume the topic and then relay the changes out to the front end via websockets.</p>

<p>There are two ways of achieving this.  The more complex option would be to publish the changes from the application server, or use the <a href="https://neo4j.com/docs/labs/neo4j-streams/">Neo4j Streams</a> plugin to turn Neo4j into a Publisher.</p>

<p><a href="https://neo4j.com/docs/labs/neo4j-streams/">Neo4j Streams</a> is a neo4j plugin that allows you to create Producers and/or Consumers directly inside neo4j by editing a few lines of <code>neo4j.conf</code>.  By installing the plugin, a set of procedures are made available in neo4j to publish.  You <em>could</em>  <code>CALL streams.publish(topic, payload)</code> in cypher but that still seems like too much work.</p>

<p>Neo4j Streams also allows you to publish to or consume from a Kafka topic with a few lines of config.</p>

<h4 id="installing-neo4j-streams">Installing Neo4j Streams</h4>

<p><a href="https://neo4j.com/docs/labs/neo4j-streams/current/">Full installation instructions are available here</a> but in short, you download the <a href="https://github.com/neo4j-contrib/neo4j-streams/releases/latest"> *.jar file for the latest release</a> and copy it to the <code>plugins</code> folder of your neo4j instance.  Then, in <code>neo4j.conf</code> add in a couple of items with references to the zookeeper server and any kafka servers to bootstrap to (separated by a comma).</p>

<div class="file">neo4j.conf</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">kafka.zookeeper.connect=zookeeper.url:2181
kafka.bootstrap.servers=kafka.url:9092</code></pre></div>
<h4 id="configuring-the-sink">Configuring the Sink</h4>

<p>By configuring the neo4j server as a <em>Sink</em>, you can publish updates to a Kafka Topic at the end of every transaction.  Neo4j Streams allows you to set this up by adding a few more lines to the <code>neo4j.conf</code> file.  After configuring the server as a source, there are options to define patterns, each of which will be checked when a transaction is committed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">streams.source.topic.nodes.&lt;TOPIC_NAME&gt;=&lt;PATTERN&gt;
streams.source.topic.relationships.&lt;TOPIC_NAME&gt;=&lt;PATTERN&gt;</code></pre></div>
<p>I have a queue set up in kafka called <code>locks</code>, so I can configure neo4j to update kafka when the status, x or y properties of a <code>Node</code> node are updated.  You can either supply a wildcard <code>{*}</code> to include all properties or provide a list inside braces separated by a comma (<code>{prop1, prop2}</code>).  Prefixing a property with a minus sign <code>{-prop3}</code> will exclude it from the filter.  You can <a href="https://neo4j.com/docs/labs/neo4j-streams/current/producer/#producer-patterns">apply many patterns</a> to this config by splitting with a semicolon.</p>

<pre><code># enable it
streams.source.enabled=true
streams.source.topic.nodes.locks=Node{status,x,y}
</code></pre>

<p>After restarting the database to apply the settings and running a cypher query - you can see that</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cypher" data-lang="cypher">MATCH (n:Node)
SET n.status = &#39;locked&#39;, n.x = rand()*100, n.y = rand()*100</code></pre></div>
<p><img src="/uploads/real-time-ui-vuejs-neo4j-kafka/fig2.png" alt="Changes listed in Kafka" title="A list of updates for a set of nodes in Lenses UI" /></p>

<h3 id="listening-for-changes-in-the-api">Listening for Changes in the API</h3>

<p>Now, the only thing left to do is to messages published to the Kafka topic in the API and push those out to the front end.  For this, the API will need a Kafka consumer.  This is done with the <code>kafka-node</code> package installed earlier.</p>

<p>The first step is to create a client to connect to the Kafka host.  Because <code>.env</code> is already setup and working with neode, I&rsquo;ll add a the configuration options for the kafka server(s), topic and consumer group to .env</p>

<div class="file">.env</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-env" data-lang="env">KAFKA_SERVER=kafka.url:9092
KAFKA_TOPIC=locks
KAFKA_GROUP=LocksGroup1</code></pre></div>
<p>Then the next step is to create a client to connect to Kafka, then a consumer that will listen to the locks topic.  By specifying a group, you can either split the consumption of the topic over a number of servers, or in this case by supplying different groups for each application server - each application server and subsequent user will receive the update.</p>

<div class="file">api/src/consumer.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">kafka</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;kafka-node&#39;</span>)

<span style="color:#75715e">// Client
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">kafka</span>.<span style="color:#a6e22e">KafkaClient</span>({ <span style="color:#a6e22e">kafkaHost</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">KAFKA_SERVER</span> });

<span style="color:#75715e">// Consumer
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">consumer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">kafka</span>.<span style="color:#a6e22e">Consumer</span>(
    <span style="color:#a6e22e">client</span>,
    <span style="color:#75715e">// You can supply more than one topic here
</span><span style="color:#75715e"></span>    [ { <span style="color:#a6e22e">topic</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">KAFKA_TOPIC</span>, <span style="color:#a6e22e">partition</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> } ],
    {
        <span style="color:#a6e22e">groupId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">KAFKA_GROUP</span>,
        <span style="color:#a6e22e">autoCommit</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
        <span style="color:#a6e22e">fetchMaxWaitMs</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1000</span>,
        <span style="color:#a6e22e">fetchMaxBytes</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>,
        <span style="color:#a6e22e">encoding</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;utf8&#39;</span>,
        <span style="color:#a6e22e">fromOffset</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>
    }
);

<span style="color:#75715e">// Export it so we can use it later
</span><span style="color:#75715e"></span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">consumer</span>;
</code></pre></div>
<p>Then the only thing left to do is consume the messages as the come in from the topic.  Because the consumer is only listening on a single topic there&rsquo;s no need to check the message when it comes in - just the type.</p>

<p>The interface for listening is the same as socket.io, when a message comes in we want to emit it to each connected socket.</p>

<div class="file">api/src/io.js</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"> <span style="color:#75715e">// Now with added consumer parameter
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createSocket</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">neode</span>, <span style="color:#a6e22e">consumer</span>) =&gt; {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Listen for Kafka 
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">consumer</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;message&#39;</span>, ({ <span style="color:#a6e22e">value</span>, }) =&gt; {
        <span style="color:#75715e">// Parse the JSON value into an object
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">payload</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">value</span>)

        <span style="color:#75715e">// Get the properties from the update
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">properties</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">after</span>

        <span style="color:#75715e">// ... and the status
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">status</span>, } <span style="color:#f92672">=</span> <span style="color:#a6e22e">properties</span>

        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;\n\nemitting from kafka:&#39;</span>, <span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">properties</span>)

        <span style="color:#75715e">// Emit the message through all connected sockets
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">properties</span>)
    })
}
</code></pre></div>
<p>That&rsquo;s it!  When a message comes in, the payload will include a value that includes <code>before</code> and <code>after</code> objects that show the state of the node before and after the transaction.  Because the status properties are the same as the messages, this can be used as the message name, and the entire property object can be sent as the payload.</p>

<h2 id="next-steps">Next Steps</h2>

<p>This is quite a basic example, but you could use this to do some pretty clever things.  For example, neo4j could push the information to another topic, which another topic listens to, runs some aggregation and then passes the new value to another queue.</p>

<p>Neo4j could be used a as a conusmer as well as a <a href="https://neo4j.com/docs/labs/neo4j-streams/current/consumer/">Consumer</a> as well as a Producer and process messages directly from a Kafka topic.</p>

<p>On the websockets side, Socket.io has <a href="https://socket.io/docs/rooms-and-namespaces/">Rooms and Namespaces</a> functionality that could be used for a multi-tenancy system.  As a connection is received, some authentication could take place that resulted in the user joining a room belonging to it&rsquo;s organisation.  That way only the relevant messages are sent to each user.</p>

<p>The <a href="https://github.com/adam-cowley/real-time-ui-vuejs-neo4j-kafka">code is up on github</a>, feel free to clone and play for yourself.</p>


				

				



    <i class="lnr lnr-tag tag-icon"></i>
    <ul class="tags">
        
        <li>
            <a href="http://www.adamcowley.co.uk/tags/neo4j/">neo4j</a>
        </li>
        <li>
            <a href="http://www.adamcowley.co.uk/tags/nodejs/">nodejs</a>
        </li>
        <li>
            <a href="http://www.adamcowley.co.uk/tags/kafka/">kafka</a>
        </li>
        <li>
            <a href="http://www.adamcowley.co.uk/tags/socket.io/">socket.io</a>
        </li>
        <li>
            <a href="http://www.adamcowley.co.uk/tags/vuejs/">vuejs</a>
        </li></ul>



			</article>
		</section>
	</div>

	
			</section>
		</main>

		<footer class="footer" role="contentinfo">
			

			<div class="container">
				<p class="copyright">
					Copyright &copy; 2019  Adam Cowley.
				</p>
			</div>
			<div class="social">
				<div class="container">
					<ul>
						<li>
        <a href="http://twitter.com/adamcowley" target="_blank">
            <svg style="height:24px;width:24px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve"> <path id="Twitter__x28_alt_x29_" d="M84.803,46.564c5.055-0.417,8.483-2.715,9.803-5.833c-1.824,1.12-7.484,2.341-10.61,1.178 	c-0.153-0.734-0.324-1.432-0.492-2.062c-2.382-8.746-10.537-15.792-19.082-14.941c0.691-0.279,1.392-0.539,2.092-0.772 	c0.94-0.337,6.459-1.235,5.59-3.183c-0.733-1.713-7.475,1.295-8.744,1.688c1.675-0.63,4.447-1.714,4.743-3.64 	c-2.567,0.352-5.087,1.566-7.034,3.331c0.703-0.757,1.236-1.679,1.349-2.672C55.57,24.033,51.57,32.853,48.333,41.408 	c-2.542-2.463-4.795-4.403-6.816-5.48c-5.67-3.041-12.449-6.213-23.091-10.164c-0.327,3.521,1.741,8.203,7.7,11.316 	c-1.291-0.173-3.652,0.213-5.54,0.665c0.769,4.034,3.28,7.357,10.079,8.964c-3.107,0.205-4.713,0.912-6.168,2.436 	c1.415,2.805,4.868,6.107,11.08,5.429c-6.906,2.977-2.816,8.49,2.804,7.667C28.794,72.143,13.679,71.416,5,63.134 	c22.661,30.879,71.921,18.262,79.262-11.481c5.499,0.047,8.733-1.905,10.738-4.057C91.831,48.134,87.239,47.578,84.803,46.564z"></path> </svg>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/adamcowley/" target="_blank">
            <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve" style="enable-background:new 0 0 100 100; width: 18px;height: 26px;">
<path id="LinkedIn__x28_alt_x29_" d="M87.877,5.608H11.174c-3.673,0-6.65,2.886-6.65,6.448v77.101c0,3.562,2.978,6.451,6.65,6.451
h76.703c3.673,0,6.646-2.89,6.646-6.451V12.056C94.523,8.495,91.55,5.608,87.877,5.608z M31.809,80.944H18.211V40.31h13.598V80.944z
M25.011,34.759H24.92c-4.56,0-7.516-3.119-7.516-7.023c0-3.983,3.043-7.017,7.693-7.017c4.651,0,7.512,3.033,7.602,7.017
C32.699,31.641,29.749,34.759,25.011,34.759z M80.827,80.944H67.233v-21.74c0-5.464-1.97-9.191-6.886-9.191
c-3.761,0-5.993,2.515-6.973,4.942c-0.364,0.868-0.453,2.08-0.453,3.292v22.696H39.329c0,0,0.178-36.823,0-40.634h13.593v5.761
c1.805-2.768,5.029-6.717,12.249-6.717c8.947,0,15.656,5.804,15.656,18.291V80.944z M52.834,46.199
c0.024-0.038,0.056-0.084,0.088-0.128v0.128H52.834z" />
</svg>
        </a>
    </li>
					</ul>
				</div>
			</div>
		</footer>
	</div>





<script src="/js/parts/scripts.js"></script>

</body>
</html>
