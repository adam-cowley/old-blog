<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ES6 Promises - 5 Things I Wish I Had Known - Adam Cowley | Full Stack Development Lead specialising in Neo4j and Node JS</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="ES6 Promises - 5 Things I Wish I Had Known" />
<meta property="og:description" content="Five things that I wish someone had told me before I started out with ES6 Promises" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.adamcowley.co.uk/javascript/es6-promises-tips-and-tricks/" />
<meta property="article:published_time" content="2016-03-03T10:21:09&#43;00:00"/>
<meta property="article:modified_time" content="2016-03-03T10:21:09&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ES6 Promises - 5 Things I Wish I Had Known"/>
<meta name="twitter:description" content="Five things that I wish someone had told me before I started out with ES6 Promises"/>


	
	<link rel="stylesheet" type="text/css" media="screen" href="/css/adamcowley.css" />

	
	
</head>

<body>
		<header class="header clear" role="banner" id="header">
		<div class="container">
			<h1 class="logo">
				<a href="/">
					<img src="/img/ac-green.svg" alt="Adam Cowley | Full Stack Development Lead specialising in Neo4j and Node JS">
				</a>
			</h1>
			<nav class="nav" role="navigation">
				<ul>
					
					<li>
						<a href="/about-me/">about</a>
					</li>
					
					<li>
						<a href="/categories/javascript/">javascript</a>
					</li>
					
					<li>
						<a href="/categories/neo4j/">neo4j</a>
					</li>
					<li>
        <a href="http://twitter.com/adamcowley" target="_blank">
            <svg style="height:24px;width:24px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve"> <path id="Twitter__x28_alt_x29_" d="M84.803,46.564c5.055-0.417,8.483-2.715,9.803-5.833c-1.824,1.12-7.484,2.341-10.61,1.178 	c-0.153-0.734-0.324-1.432-0.492-2.062c-2.382-8.746-10.537-15.792-19.082-14.941c0.691-0.279,1.392-0.539,2.092-0.772 	c0.94-0.337,6.459-1.235,5.59-3.183c-0.733-1.713-7.475,1.295-8.744,1.688c1.675-0.63,4.447-1.714,4.743-3.64 	c-2.567,0.352-5.087,1.566-7.034,3.331c0.703-0.757,1.236-1.679,1.349-2.672C55.57,24.033,51.57,32.853,48.333,41.408 	c-2.542-2.463-4.795-4.403-6.816-5.48c-5.67-3.041-12.449-6.213-23.091-10.164c-0.327,3.521,1.741,8.203,7.7,11.316 	c-1.291-0.173-3.652,0.213-5.54,0.665c0.769,4.034,3.28,7.357,10.079,8.964c-3.107,0.205-4.713,0.912-6.168,2.436 	c1.415,2.805,4.868,6.107,11.08,5.429c-6.906,2.977-2.816,8.49,2.804,7.667C28.794,72.143,13.679,71.416,5,63.134 	c22.661,30.879,71.921,18.262,79.262-11.481c5.499,0.047,8.733-1.905,10.738-4.057C91.831,48.134,87.239,47.578,84.803,46.564z"></path> </svg>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/adamcowley/" target="_blank">
            <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve" style="enable-background:new 0 0 100 100; width: 18px;height: 26px;">
<path id="LinkedIn__x28_alt_x29_" d="M87.877,5.608H11.174c-3.673,0-6.65,2.886-6.65,6.448v77.101c0,3.562,2.978,6.451,6.65,6.451
h76.703c3.673,0,6.646-2.89,6.646-6.451V12.056C94.523,8.495,91.55,5.608,87.877,5.608z M31.809,80.944H18.211V40.31h13.598V80.944z
M25.011,34.759H24.92c-4.56,0-7.516-3.119-7.516-7.023c0-3.983,3.043-7.017,7.693-7.017c4.651,0,7.512,3.033,7.602,7.017
C32.699,31.641,29.749,34.759,25.011,34.759z M80.827,80.944H67.233v-21.74c0-5.464-1.97-9.191-6.886-9.191
c-3.761,0-5.993,2.515-6.973,4.942c-0.364,0.868-0.453,2.08-0.453,3.292v22.696H39.329c0,0,0.178-36.823,0-40.634h13.593v5.761
c1.805-2.768,5.029-6.717,12.249-6.717c8.947,0,15.656,5.804,15.656,18.291V80.944z M52.834,46.199
c0.024-0.038,0.056-0.084,0.088-0.128v0.128H52.834z" />
</svg>
        </a>
    </li>
				</ul>
			</nav>
		</div>
	</header>

	<div class="main">

		<main role="main">

		<section>




	<div class="introduction">
		<div class="container">
			
			<h1>ES6 Promises - 5 Things I Wish I Had Known</h1>
		</div>
	</div>

	<div class="container content single">
		<section>
			<article class="post">
				<p class="date">
					<time datetime="2016-03-03 10:21">
						03/03/2016 10:21
					</time>
				</p>

				<p>Over the past couple of months I&#8217;ve started shifting my development focus away from PHP to Node.  Node is a huge departure from PHP development and I&#8217;ve uncovered quite a few gotcha&#8217;s along the way.</p>

<p>One of the major differences is the Asynchronous nature of JavaScript.  If you&#8217;ve ever wondered why people say the MEAN stack is quick, this is why.  Where PHP will run all code in sequence, JavaScript will run multiple requests at once, asynchronously.</p>

<p>Although this makes end requests a lot faster, it can lead to <em>callback hell </em>. If you&#8217;ve spent any time writing JavaScript then you&#8217;ve probably come across the terms <a href="https://medium.com/@wavded/managing-node-js-callback-hell-1fe03ba8baf" target="_blank"><em>callback hell</em></a> or <a href="http://tritarget.org/blog/2012/11/28/the-pyramid-of-doom-a-javascript-style-trap/" target="_blank"><em>the pyramid of doom</em></a>, a phenomenon which can lead to some pretty unwieldy code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">originalFunction</span>(
    <span style="color:#a6e22e">firstCallback</span>(
        <span style="color:#a6e22e">secondCallback</span>(
            <span style="color:#a6e22e">thirdCallback</span>(
                <span style="color:#a6e22e">fourthCallback</span>(
                    <span style="color:#a6e22e">fifthCallback</span>(
                    )
                )
            )
        )
    )
)
</code></pre></div>
<p>Promises are the ES6&#8217;s answer to this problem, allowing you to chain your functions and make your code much easier to follow.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">originalFunction</span>()
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">output</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">firstPromise</span>(<span style="color:#a6e22e">output</span>);
})
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">output2</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">secondPromise</span>(<span style="color:#a6e22e">output2</span>);
})
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">output3</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">thirdOutput</span>(<span style="color:#a6e22e">output3</span>);
})
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">final_output</span>) {
    <span style="color:#75715e">// Finally, do something
</span><span style="color:#75715e"></span>});
</code></pre></div>
<p>I&#8217;ve spent a lot of my time writing wrappers to existing <code>npm</code> modules to work with a promise based approach. It&#8217;s been an emotional journey full of pain and joy. Here are a few things I wish I&#8217;d known before I&#8217;d started.</p>

<h2>
    Tip 1 &#8211; <b>Forget <code>.defer()</code>.</b>
</h2>

<p>
    Coming at Promises from Angular, I&#8217;d developed the bad habit of using the <code>$q.defer()</code> approach. The official implementation takes a much simpler approach. Using <code>new Promise</code> to create a Promise will pass two functions into your callback which will allow you to resolve or reject the promise.
</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) {
    <span style="color:#a6e22e">GetSomething</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">res</span>) {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
            <span style="color:#75715e">// Catch this using .catch()
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
        }
        <span style="color:#75715e">// Will pass through value to .then()
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">res</span>);
    });
});
</code></pre></div>
<h2>
    Tip 2 &#8211;<b>You can resolve a Promise straight away.</b>
</h2>

<p>
    If you have a Promise with no possibility of failing, you can resolve it straight away using <code>Promise.resolve()</code>
</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">Promise.<span style="color:#a6e22e">resolve</span>(<span style="color:#ae81ff">100</span>)
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">output</span>) {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">output</span>) <span style="color:#75715e">// 100
</span><span style="color:#75715e"></span>});
</code></pre></div>
<h2>
    Tip 3 &#8211; <b>You can return another promise.</b>
</h2>

<p>
    This is probably the most important thing to remember and one that has caused me a few headaches. When I first started, I found myself slipping back into my own variation of callback hell, ending up with something like the following.
</p>

<pre><code>// Welcome to Promise Hell...
return new Promise((resolve, reject) =&gt; {
    promise1()
    .then((output) =&gt; {
        promise2(output)
        .then((output2) =&gt; {
            promise3(output3)
            .then((final) =&gt; {
                console.log(final)
            });
        });
    });
});
</code></pre>

<p>This is terrible. Not only does it make things just as complicated, you&#8217;ll need to remember to apply <code>.catch()</code> to every nested promise, otherwise debugging can become a nightmare.</p>

<p>
    As well as manipulating a value within <code>then()</code>, you can also return another Promise. Not only is this a lot more readable, but an error at any point during the chain will be caught by the final <code>.catch()</code> call.
</p>

<pre><code>// Instead do this
function promise1(prev) {
	return new Promise((resolve, reject) =&gt; {
		output.push('Promise 1');
		setTimeout(() =&gt; {
			resolve(output)
		}, 500);
	});
}
function promise2(prev) {
	return new Promise((resolve, reject) =&gt; {
		output.push('Promise 2');
		setTimeout(() =&gt; {
			resolve(output)
		}, 500);
	});
}
function promise3(prev) {
	return new Promise((resolve, reject) =&gt; {
		output.push('Promise 3');
		setTimeout(() =&gt; {
			resolve(output)
		}, 500);
	});
}

let output = [];

promise1(output)
    .then((output) =&gt; {
        return promise2(output);
    })
    .then((output) =&gt; {
        return promise3(output);
    })
    .then((output) =&gt; {
        console.log(output); // ['Promise 1', 'Promise 2', 'Promise 3']
    })
    .catch((error) =&gt; {
        // Something went wrong
    });
</code></pre>

<p><b>Note:</b> Make sure you&#8217;re using <code>return</code> if you need to use the data, or the promise needs to be resolved before continuing.
</p></p>

<h2>
    Tip 4 &#8211; <b>You can wait for multiple promises to complete</b>
</h2>

<p>
    By using <code>Promise.all()</code>, your Promise will wait until all promises have been resolved before continuing. <code>Promise.all</code> will return an array of values based on the promises passed into <code>Promise.all()</code>.
</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">Promise.<span style="color:#a6e22e">all</span>([
    <span style="color:#a6e22e">getUser</span>(),
    <span style="color:#a6e22e">getPost</span>(),
    <span style="color:#e6db74">&#39;CREATED&#39;</span> <span style="color:#75715e">// You can also pass through regular variables
</span><span style="color:#75715e"></span>])
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">output</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output</span>[<span style="color:#ae81ff">0</span>];
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">post</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output</span>[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">relationship</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output</span>[<span style="color:#ae81ff">2</span>];
    <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">relateTo</span>(<span style="color:#a6e22e">post</span>, <span style="color:#a6e22e">relationship</span>);
});
</code></pre></div>
<p>It&#8217;s also important to note that if you are dealing with an array of records that need an action performed on them before continuing, you should be using <code>Promise.all()</code> instead.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">getPostsByUser</span>(<span style="color:#e6db74">&#39;adam&#39;</span>)
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">posts</span>) {
    <span style="color:#66d9ef">return</span> Promise.<span style="color:#a6e22e">all</span>(<span style="color:#a6e22e">posts</span>.<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">post</span>) {
        <span style="color:#a6e22e">db</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">post</span>.<span style="color:#a6e22e">id</span>);
    }));
})
.<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>() {
    <span style="color:#75715e">// Now it is safe to delete the User
</span><span style="color:#75715e"></span>});
</code></pre></div>
<p>Using a simple <code>forEach</code> on the posts array in this example will delete each post, but could cause issues if the action does not succeed before the next stage is processed. Using <code>Promise.all()</code> ensures that all actions are completed before the next stage begins.</p>

<h2>
    Tip 5 &#8211; <b><code>.catch()</code> is shorthand</b>
</h2>

<p>
    The <code>catch()</code> function is a shorthand for <code>then(null, ...)</code>. However, there are two important gotcha&#8217;s here. Firstly, consider the two following snippets of code. Although they look familiar, they are not equivalent.
</p>

<pre><code>db.delete(record)
.then(function success() {
    // Record has been deleted
}, function error() {
    // There has been an error in this block
});
</code></pre>

<pre><code>db.delete(record)
.then(function success() {
    // Record has been deleted
).catch(function error() {
    // There has been an error at some point in the chain
});
</code></pre>

<p>The main issue when using the <code>then(resolveHandler, rejectHandler)</code> format, is that the <code>rejectHandler</code> will not catch an error if it is thrown within the <code>resolveHandler</code>, meaning you would need to add an extra level below to catch this error.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">db</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">record</span>)
    .<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">success</span>() {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Something has gone wrong&#39;</span>)
    }, <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">error</span>() {
        <span style="color:#75715e">// &#39;Something has gone wrong&#39; will not be caught here
</span><span style="color:#75715e"></span>    })
    .<span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">error</span>) {
        <span style="color:#75715e">// ...instead it will be caught here
</span><span style="color:#75715e"></span>    });
</code></pre></div>
<p>The second gotcha here is that using the <code>then(resolveHandler, rejectHandler)</code> format will not halt the chain.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">db</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">record</span>)
    .<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">success</span>() {
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Something has gone wrong&#39;</span>)
    }, <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">error</span>() {
        <span style="color:#75715e">// &#39;Something has gone wrong&#39; will not be caught here
</span><span style="color:#75715e"></span>    })
    .<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">res</span>) {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">res</span>); <span style="color:#75715e">// Error: &#39;Something has gone wrong&#39;
</span><span style="color:#75715e"></span>    });
</code></pre></div>
<p>For this reason I always tend to omit the second argument for <code>then()</code> and instead use a final <code>catch()</code> at the end of the chain.</p>

<h2>
    Conclusion
</h2>

<p>
    Promises are a great feature of Node JS, but getting your head around them can be a nightmare. If I had known these things before I&#8217;d began it would have saved me a few headaches. Hopefully this will save someone else&#8217;s sanity.
</p>


				
			</article>
		</section>
	</div>

	
			</section>
		</main>

		<footer class="footer" role="contentinfo">
			<div class="social">
				<div class="container">
					<ul>
						<li>
        <a href="http://twitter.com/adamcowley" target="_blank">
            <svg style="height:24px;width:24px" version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve"> <path id="Twitter__x28_alt_x29_" d="M84.803,46.564c5.055-0.417,8.483-2.715,9.803-5.833c-1.824,1.12-7.484,2.341-10.61,1.178 	c-0.153-0.734-0.324-1.432-0.492-2.062c-2.382-8.746-10.537-15.792-19.082-14.941c0.691-0.279,1.392-0.539,2.092-0.772 	c0.94-0.337,6.459-1.235,5.59-3.183c-0.733-1.713-7.475,1.295-8.744,1.688c1.675-0.63,4.447-1.714,4.743-3.64 	c-2.567,0.352-5.087,1.566-7.034,3.331c0.703-0.757,1.236-1.679,1.349-2.672C55.57,24.033,51.57,32.853,48.333,41.408 	c-2.542-2.463-4.795-4.403-6.816-5.48c-5.67-3.041-12.449-6.213-23.091-10.164c-0.327,3.521,1.741,8.203,7.7,11.316 	c-1.291-0.173-3.652,0.213-5.54,0.665c0.769,4.034,3.28,7.357,10.079,8.964c-3.107,0.205-4.713,0.912-6.168,2.436 	c1.415,2.805,4.868,6.107,11.08,5.429c-6.906,2.977-2.816,8.49,2.804,7.667C28.794,72.143,13.679,71.416,5,63.134 	c22.661,30.879,71.921,18.262,79.262-11.481c5.499,0.047,8.733-1.905,10.738-4.057C91.831,48.134,87.239,47.578,84.803,46.564z"></path> </svg>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/adamcowley/" target="_blank">
            <svg version="1.1" id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
width="100px" height="100px" viewBox="0 0 100 100" xml:space="preserve" style="enable-background:new 0 0 100 100; width: 18px;height: 26px;">
<path id="LinkedIn__x28_alt_x29_" d="M87.877,5.608H11.174c-3.673,0-6.65,2.886-6.65,6.448v77.101c0,3.562,2.978,6.451,6.65,6.451
h76.703c3.673,0,6.646-2.89,6.646-6.451V12.056C94.523,8.495,91.55,5.608,87.877,5.608z M31.809,80.944H18.211V40.31h13.598V80.944z
M25.011,34.759H24.92c-4.56,0-7.516-3.119-7.516-7.023c0-3.983,3.043-7.017,7.693-7.017c4.651,0,7.512,3.033,7.602,7.017
C32.699,31.641,29.749,34.759,25.011,34.759z M80.827,80.944H67.233v-21.74c0-5.464-1.97-9.191-6.886-9.191
c-3.761,0-5.993,2.515-6.973,4.942c-0.364,0.868-0.453,2.08-0.453,3.292v22.696H39.329c0,0,0.178-36.823,0-40.634h13.593v5.761
c1.805-2.768,5.029-6.717,12.249-6.717c8.947,0,15.656,5.804,15.656,18.291V80.944z M52.834,46.199
c0.024-0.038,0.056-0.084,0.088-0.128v0.128H52.834z" />
</svg>
        </a>
    </li>
					</ul>
				</div>
			</div>

			<div class="container">
				<p class="copyright">
					Copyright &copy; 2019  Adam Cowley.
				</p>
			</div>
		</footer>
	</div>





<script src="/js/parts/scripts.js"></script>

</body>
</html>
